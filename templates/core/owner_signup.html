{% load static socialaccount %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Owner Sign Up — Dine N Dash</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Force Django to mint a CSRF token and expose it -->
  <form style="display:none">{% csrf_token %}</form>
  <meta name="csrf-token" content="{{ csrf_token }}">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen p-8">
  <div class="max-w-xl mx-auto bg-white border rounded-2xl p-8 shadow-sm">
    <h1 class="text-2xl font-bold">Owner Sign Up</h1>
    <div id="alert" class="hidden mt-3 text-sm px-3 py-2 rounded"></div>

    <!-- Step 1: owner details -->
    <div id="step1" class="mt-6 grid grid-cols-2 gap-3">
      <input id="first_name" class="border rounded p-3 col-span-1" placeholder="First name" autocomplete="given-name">
      <input id="last_name"  class="border rounded p-3 col-span-1" placeholder="Last name" autocomplete="family-name">
      <input id="email"      class="border rounded p-3 col-span-2" placeholder="Email" autocomplete="email">
      <input id="phone"      class="border rounded p-3 col-span-2" placeholder="+15551234567" autocomplete="tel">
      <input id="p1" type="password" class="border rounded p-3 col-span-1" placeholder="Password" autocomplete="new-password">
      <input id="p2" type="password" class="border rounded p-3 col-span-1" placeholder="Confirm password" autocomplete="new-password">
      <button id="go" class="col-span-2 bg-black text-white rounded p-3">Create account</button>

      <div class="col-span-2 mt-4 text-center">
        <p class="text-sm text-slate-500">— or —</p>
        <a href="{% url 'core:owner_google_start' %}"
           class="mt-3 inline-flex items-center justify-center w-full h-12 rounded-2xl border border-slate-300 text-slate-700 hover:bg-slate-50">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="h-5 w-5 mr-2">
          Continue with Google
        </a>
      </div>
    </div>

    <!-- Step 2: phone OTP -->
    <div id="step2" class="mt-6 hidden">
      <p class="text-sm text-slate-600 mb-2">Enter the 6-digit code sent to your phone.</p>
      <input id="code_phone" class="border rounded p-3 w-full" maxlength="6" placeholder="123456" inputmode="numeric" pattern="[0-9]*">
      <div class="mt-3 flex gap-2">
        <button id="verify_phone" class="bg-black text-white rounded p-3 flex-1">Verify phone</button>
        <button id="resend" class="border rounded p-3 flex-1">Resend code</button>
      </div>
    </div>

    <!-- Step 3: email OTP -->
    <div id="step3" class="mt-6 hidden">
      <p class="text-sm text-slate-600 mb-2">Enter the 6-digit code we emailed you.</p>
      <input id="code_email" class="border rounded p-3 w-full" maxlength="6" placeholder="123456" inputmode="numeric" pattern="[0-9]*">
      <button id="verify_email" class="mt-3 bg-black text-white rounded p-3 w-full">Verify email</button>
    </div>
  </div>

<script>
  // --- helpers ---
  function flash(msg, ok=false){
    const el = document.getElementById('alert');
    el.className = 'mt-3 text-sm px-3 py-2 rounded ' + (ok ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800');
    el.textContent = msg;
    el.classList.remove('hidden');
  }
  function getCSRF(){
    // prefer meta, fallback to cookie
    const m = document.querySelector('meta[name="csrf-token"]');
    if (m && m.content) return m.content.replace(/^['"]|['"]$/g, '');
    const c = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);
    return c ? c[1] : '';
  }
  async function postJSON(url, payload){
    const r = await fetch(url, {
      method: 'POST',
      credentials: 'same-origin', // IMPORTANT: send cookies
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRF()  // IMPORTANT: send token
      },
      body: JSON.stringify(payload || {})
    });
    let data = {};
    try { data = await r.json(); } catch {}
    return { ok: r.ok, data };
  }

  // --- elements ---
  const step1 = document.getElementById('step1');
  const step2 = document.getElementById('step2');
  const step3 = document.getElementById('step3');

  // --- Step 1 submit ---
  document.getElementById('go').addEventListener('click', async () => {
    const payload = {
      first_name: document.getElementById('first_name').value.trim(),
      last_name:  document.getElementById('last_name').value.trim(),
      email:      document.getElementById('email').value.trim().toLowerCase(),
      phone:      document.getElementById('phone').value.trim(),
      password1:  document.getElementById('p1').value,
      password2:  document.getElementById('p2').value
    };
    const { ok, data } = await postJSON("{% url 'core:owner_signup_api' %}", payload);
    if (ok && data.ok && data.stage === 'phone') {
      flash('Code sent to your phone.', true);
      step1.classList.add('hidden');
      step2.classList.remove('hidden');
    } else {
      flash(data.error || 'Could not start sign up.');
    }
  });

  // --- Verify phone ---
  document.getElementById('verify_phone').addEventListener('click', async () => {
    const code = document.getElementById('code_phone').value.trim();
    if (!/^\d{6}$/.test(code)) return flash('Enter the 6-digit code.');
    const { ok, data } = await postJSON("{% url 'core:owner_verify_phone_api' %}", { code });
    if (ok && data.ok && data.stage === 'email') {
      flash('Phone verified. Check your email for a code.', true);
      step2.classList.add('hidden');
      step3.classList.remove('hidden');
    } else {
      flash(data.error || 'Phone verification failed.');
    }
  });

  // --- (Optional) resend via a dedicated endpoint if you add one server-side ---
  document.getElementById('resend').addEventListener('click', () => {
    flash('If you need to change your phone, go back and re-submit step 1.');
  });

  // --- Verify email ---
  document.getElementById('verify_email').addEventListener('click', async () => {
    const code = document.getElementById('code_email').value.trim();
    if (!/^\d{6}$/.test(code)) return flash('Enter the 6-digit code.');
    const { ok, data } = await postJSON("{% url 'core:owner_verify_email_api' %}", { code });
    if (ok && data.ok && data.redirect) {
      location.href = data.redirect;
    } else {
      flash(data.error || 'Email verification failed.');
    }
  });

  // --- IMPORTANT: stay on one origin to avoid CSRF mismatches ---
  // Use either http://127.0.0.1:8000 or http://localhost:8000 consistently.
</script>
</body>
</html>

