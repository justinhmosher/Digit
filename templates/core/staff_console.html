<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Staff Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="csrf-token" content="{{ csrf_token }}">
</head>
<body class="bg-slate-50 min-h-screen">
  <!-- Top bar -->
  <header class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b">
    <div class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-2xl bg-slate-900 text-white grid place-items-center font-semibold">D</div>
        <div>
          <div class="font-semibold tracking-tight">Server Console</div>
          <div class="text-xs text-slate-500">Auto tip on staff close: <span id="autoTip">{{ auto_tip_pct }}</span>%</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <div class="hidden md:flex items-center gap-2">
          <input id="search" placeholder="Search ticket / table / member…" class="h-10 w-64 rounded-xl border px-3 text-sm">
          <button id="refreshBtn" class="h-10 px-4 rounded-xl border text-sm hover:bg-slate-50">Refresh</button>
        </div>
        <button id="openLinkDrawer" class="h-10 px-4 rounded-xl bg-slate-900 text-white text-sm">+ Link customer</button>
      </div>
    </div>
  </header>

  <!-- Alerts -->
  <div id="toast" class="fixed top-3 inset-x-0 z-30 hidden">
    <div id="toastBox" class="mx-auto max-w-xl rounded-2xl border px-4 py-3 bg-white shadow"></div>
  </div>

  <!-- Board -->
  <main class="mx-auto max-w-7xl px-4 py-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Pending -->
      <section>
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-semibold">Pending verification</h2>
          <span id="pendingCount" class="text-xs text-slate-500"></span>
        </div>
        <div id="col-pending" class="space-y-3">
          <div class="text-sm text-slate-500">Nothing pending.</div>
        </div>
      </section>

      <!-- Open -->
      <section>
        <h2 class="font-semibold mb-2">Open tabs</h2>
        <div id="col-open" class="space-y-3">
          <div class="text-sm text-slate-500">No open tabs.</div>
        </div>
      </section>

      <!-- Closed -->
      <section>
        <h2 class="font-semibold mb-2">Closed (last 12h)</h2>
        <div id="col-closed" class="space-y-3">
          <div class="text-sm text-slate-500">Nothing closed in last 12h.</div>
        </div>
      </section>
    </div>

    <!-- Activity Log -->
    <div class="mt-8 rounded-2xl border bg-white p-4">
      <h3 class="font-semibold mb-2">Activity</h3>
      <ul id="activity" class="space-y-1 text-sm text-slate-700"></ul>
    </div>
  </main>

  <!-- Drawer: Link customer -->
  <div id="drawerWrap" class="fixed inset-0 z-40 hidden">
    <div id="drawerBg" class="absolute inset-0 bg-black/30 opacity-0 transition-opacity"></div>
    <aside id="drawer" class="absolute right-0 top-0 h-full w-[560px] max-w-full bg-white shadow-2xl translate-x-full transition-transform">
      <div class="p-5 border-b flex items-center justify-between">
        <h3 class="text-lg font-semibold">Link customer</h3>
        <button id="closeDrawer" class="rounded-xl border px-3 py-1 text-sm hover:bg-slate-50">Close</button>
      </div>

      <div class="p-5 space-y-4">
        <p class="text-sm text-slate-600">
          Enter a ticket hint (ticket #, table, or server). Add one or more member numbers; click “Add member” to include more guests.
          We’ll text each guest a verification link.
        </p>

        <div class="grid gap-3">
          <input id="hint" class="h-12 rounded-xl border px-4" placeholder="Ticket # / table / server" />
        </div>

        <div>
          <div class="flex items-center justify-between">
            <div class="text-sm font-medium">Members</div>
          </div>
          <div id="memberList" class="mt-2 space-y-2">
            <!-- inputs injected here -->
          </div>
        </div>

        <div class="pt-2">
          <button id="sendLinks" class="h-12 w-full rounded-xl bg-slate-900 text-white disabled:opacity-50">Send verification links</button>
          <div id="drawerBusy" class="text-xs text-slate-500 mt-2 hidden">Sending…</div>
        </div>

        <div class="pt-4">
          <div class="text-xs font-medium text-slate-500">Result log</div>
          <ul id="drawerLog" class="mt-2 space-y-1 text-sm"></ul>
        </div>
      </div>
    </aside>
  </div>

  <script>
    // --- helpers ---
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    function cents(n){ return (n/100).toFixed(2); }
    function csrf(){ const m = document.cookie.match(/(?:^|;\\s*)csrftoken=([^;]+)/); return m ? decodeURIComponent(m[1]) : (document.querySelector('meta[name="csrf-token"]')?.content || ''); }
    function toast(msg, tone='info'){
      const box = $("#toastBox");
      const styles = tone==='error' ? 'border-red-200 bg-red-50 text-red-900' :
                      tone==='success' ? 'border-emerald-200 bg-emerald-50 text-emerald-900' :
                      'border-slate-200 bg-white text-slate-900';
      box.className = "mx-auto max-w-xl rounded-2xl border px-4 py-3 shadow " + styles;
      box.textContent = msg;
      $("#toast").classList.remove("hidden");
      setTimeout(()=>$("#toast").classList.add("hidden"), 3000);
    }
    async function getJSON(url){
      const r = await fetch(url, {credentials:'same-origin'});
      let d={}; try{ d = await r.json() }catch{}
      return {ok:r.ok, data:d};
    }
    async function postJSON(url, body){
      const r = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type':'application/json','X-CSRFToken':csrf()},
        credentials:'same-origin',
        body: JSON.stringify(body||{})
      });
      let d={}; try{ d = await r.json() }catch{}
      return {ok:r.ok, data:d};
    }
    function addActivity(line){
      const li = document.createElement('li');
      li.textContent = line;
      $("#activity").prepend(li);
      // keep last ~40
      const kids = $$("#activity > li");
      if (kids.length > 40) kids.slice(40).forEach(el=>el.remove());
    }

    // --- endpoints ---
    const boardUrl     = "{% url 'core:staff_board_state' %}";
    const linkUrl      = "{% url 'core:link_member' %}";
    const closeUrl     = "{% url 'core:staff_close_ticket' %}";
    const resendUrl    = "{% url 'core:staff_resend_link' %}";
    const cancelUrl    = "{% url 'core:staff_cancel_link' %}";

    // --- rendering ---
    function card(html, tone){ return `<div class="rounded-xl border shadow-sm ${tone}">${html}</div>`; }

    function renderPending(list){
      const q = ($("#search").value || "").toLowerCase();
      const el = $("#col-pending");
      const rows = (list||[]).filter(x=>{
        const hay = (x.ticket_number || x.ticket_id || '') + ' ' + (x.member||'') + ' ' + (x.server||'') + ' ' + (x.member_last||'');
        return hay.toLowerCase().includes(q);
      }).map(x=>{
        return card(`
          <div class="p-4">
            <div class="flex items-center justify-between">
              <div class="font-medium">Ticket ${x.ticket_number || x.ticket_id}</div>
              <div class="text-xs text-slate-500">${x.opened_ago}</div>
            </div>
            <div class="mt-1 text-sm text-slate-700">
              ${x.server ? ('Server: ' + x.server + ' • ') : ''}Member: <span class="font-mono">${x.member}</span> ${x.member_last ? '• ' + x.member_last : ''}
            </div>
            <div class="mt-3 flex items-center gap-2">
              <button class="btn-resend rounded-lg border px-3 py-1 text-sm hover:bg-slate-50" data-id="${x.ticket_link_id}">Resend</button>
              <button class="btn-cancel rounded-lg border px-3 py-1 text-sm hover:bg-slate-50" data-id="${x.ticket_link_id}">Cancel</button>
            </div>
          </div>
        `,'bg-amber-50');
      });
      el.innerHTML = rows.join('') || `<div class="text-sm text-slate-500">Nothing pending.</div>`;
      $("#pendingCount").textContent = rows.length ? `${rows.length}` : '';
    }

    function renderOpen(list){
      const q = ($("#search").value || "").toLowerCase();
      const el = $("#col-open");
      const rows = (list||[]).filter(x=>{
        const hay = (x.ticket_number || x.ticket_id || '') + ' ' + (x.server||'') + ' ' + (x.members||[]).join(' ');
        return hay.toLowerCase().includes(q);
      }).map(x=>{
        return card(`
          <div class="p-4">
            <div class="flex items-center justify-between">
              <div class="font-medium">Ticket ${x.ticket_number || x.ticket_id}</div>
              <div class="text-xs text-slate-500">Due $${cents(x.due_cents)}</div>
            </div>
            <div class="mt-1 text-sm text-slate-700">
              ${x.server ? 'Server: ' + x.server + ' • ' : ''}Members: ${x.members.join(', ')}
            </div>
            <div class="mt-3">
              <button class="btn-close rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm" data-ticket="${x.ticket_id}">
                Close now (auto ${document.getElementById('autoTip').textContent}%)
              </button>
            </div>
          </div>
        `,'bg-emerald-50');
      });
      el.innerHTML = rows.join('') || `<div class="text-sm text-slate-500">No open tabs.</div>`;
    }

    function renderClosed(list){
      const q = ($("#search").value || "").toLowerCase();
      const el = $("#col-closed");
      const rows = (list||[]).filter(x=>{
        const hay = (x.ticket_number || x.ticket_id || '') + ' ' + (x.member||'') + ' ' + (x.server||'') + ' ' + (x.member_last||'');
        return hay.toLowerCase().includes(q);
      }).map(x=>{
        return card(`
          <div class="p-4">
            <div class="flex items-center justify-between">
              <div class="font-medium">Ticket ${x.ticket_number || x.ticket_id}</div>
              <div class="text-xs text-slate-500">${x.closed_ago}</div>
            </div>
            <div class="mt-1 text-sm text-slate-700">
              ${x.server ? 'Server: ' + x.server + ' • ' : ''}Member: <span class="font-mono">${x.member}</span> ${x.member_last ? '• ' + x.member_last : ''}
            </div>
          </div>
        `,'bg-slate-50');
      });
      el.innerHTML = rows.join('') || `<div class="text-sm text-slate-500">Nothing closed in last 12h.</div>`;
    }

    // --- board load/patch ---
    let lastSnapshot = {pending:[], open:[], closed:[]};

    async function loadBoard(){
      const res = await getJSON(boardUrl);
      if(!res.ok || !res.data?.ok){
        toast(res.data?.error || 'Failed to load board', 'error');
        return;
      }
      lastSnapshot = res.data;
      renderPending(res.data.pending||[]);
      renderOpen(res.data.open||[]);
      renderClosed(res.data.closed||[]);
    }

    // --- actions: pending ---
    document.addEventListener('click', async (e)=>{
      const resend = e.target.closest('.btn-resend');
      if(resend){
        const id = resend.dataset.id;
        const r = await postJSON(resendUrl, {ticket_link_id: id});
        if(!r.ok || !r.data?.ok){ toast(r.data?.error || 'Resend failed','error'); return; }
        toast('Verification link resent.', 'success');
        addActivity('Resent verification for pending link #' + id);
        return;
      }
      const cancel = e.target.closest('.btn-cancel');
      if(cancel){
        const id = cancel.dataset.id;
        const r = await postJSON(cancelUrl, {ticket_link_id: id});
        if(!r.ok || !r.data?.ok){ toast(r.data?.error || 'Cancel failed','error'); return; }
        toast('Pending invite canceled.', 'success');
        addActivity('Canceled pending link #' + id);
        loadBoard();
        return;
      }
      const close = e.target.closest('.btn-close');
      if(close){
        const ticketId = close.dataset.ticket;
        const r = await postJSON(closeUrl, {ticket_id: ticketId, reference: 'staff-close'});
        if(!r.ok || !r.data?.ok){
          toast(r.data?.error || r.data?.detail || 'Close failed','error'); return;
        }
        toast('Closed with auto tip.', 'success');
        addActivity(`Closed ticket ${ticketId} (paid $${cents(r.data.paid_cents || 0)} + tip $${cents(r.data.auto_tip_cents || 0)})`);
        loadBoard();
      }
    });

    // --- drawer ---
    function openDrawer(on){
      const wrap = $("#drawerWrap"), d=$("#drawer"), bg=$("#drawerBg");
      wrap.classList.toggle('hidden', !on);
      requestAnimationFrame(()=>{ // animate
        d.style.transform = on ? 'translateX(0)' : 'translateX(100%)';
        bg.style.opacity = on ? '1' : '0';
      });
    }
    $("#openLinkDrawer").onclick = ()=>openDrawer(true);
    $("#closeDrawer").onclick = ()=>openDrawer(false);
    $("#drawerBg").onclick = ()=>openDrawer(false);

    function memberInput(value=''){
      const row = document.createElement('div');
      row.className = "flex items-center gap-2";
      row.innerHTML = `
        <input class="mem h-12 rounded-xl border px-4 flex-1" placeholder="Member number" value="${value}">
        <button class="removeMem rounded-xl border px-3 py-2 text-sm hover:bg-slate-50">Remove</button>
      `;
      row.querySelector('.removeMem').onclick = ()=>row.remove();
      return row;
    }
    // initial one
    $("#memberList").innerHTML = `
  <div class="flex items-center gap-2">
    <input id="singleMember" class="h-12 rounded-xl border px-4 flex-1" placeholder="Member number">
  </div>
`;

    $("#sendLinks").onclick = async ()=>{
      const hint = $("#hint").value.trim();
      const member = $("#singleMember").value.trim();
      if (!hint || !member) {toast("Enter ticket hint and member number", "error");return;}

      $("#sendLinks").disabled = true; $("#drawerBusy").classList.remove('hidden');
      $("#drawerLog").innerHTML = "";

const r = await postJSON(linkUrl, {
    member_number: member,
    check_hint: hint
});

let li = document.createElement("li");
if (r.ok && r.data?.ok) {
    li.className = "text-emerald-700";
    li.textContent = `${member} — link sent`;
    addActivity(`Sent verification to ${member} (hint "${hint}")`);
} else if (r.data?.multiple) {
    li.className = "text-amber-700";
    li.textContent = `${member} — multiple tickets; refine hint`;
} else {
    li.className = "text-red-700";
    li.textContent = `${member} — ${r.data?.error || "failed"}`;
}
$("#drawerLog").appendChild(li);


      $("#sendLinks").disabled = false; $("#drawerBusy").classList.add('hidden');
      // refresh board to show pending
      loadBoard();
    };

    // --- search/poll ---
    $("#search").addEventListener('input', ()=>{
      renderPending(lastSnapshot.pending||[]);
      renderOpen(lastSnapshot.open||[]);
      renderClosed(lastSnapshot.closed||[]);
    });
    $("#refreshBtn").onclick = loadBoard;

    loadBoard();
    setInterval(loadBoard, 6000); // light polling without flashes
  </script>
</body>
</html>
