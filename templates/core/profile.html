{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dyne ‚Äî Customer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body
  class="min-h-screen bg-gradient-to-b from-white to-slate-50 text-slate-900"
  data-live="{{ has_live_order|yesno:'1,0' }}"
  data-member="{{ member_number|default_if_none:'' }}"
>
  <!-- Toast -->
  <div id="toast" class="pointer-events-none fixed inset-x-0 top-3 z-[100] flex justify-center px-4 hidden">
    <div id="toastBox"
         class="pointer-events-auto max-w-xl w-full rounded-2xl border border-slate-200 px-4 py-3 shadow-lg bg-white text-slate-800 flex items-start gap-3">
      <div id="toastIcon" class="mt-[2px] h-5 w-5 rounded-full bg-slate-400"></div>
      <div class="flex-1">
        <div id="toastTitle" class="font-semibold">Notice</div>
        <div id="toastMsg" class="text-sm mt-0.5"></div>
      </div>
      <button id="toastClose" class="ml-3 rounded-xl border px-2 py-1 text-xs hover:bg-slate-50">Dismiss</button>
    </div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-30 border-b border-slate-200 bg-white/80 backdrop-blur">
    <div class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-2xl bg-slate-900 text-white grid place-items-center font-semibold">D</div>
        <span class="font-semibold tracking-tight">Dyne</span>
      </a>

      <!-- Desktop tabs -->
      <nav class="hidden md:flex items-center gap-1">
        {% if user.is_authenticated and has_live_order %}
          <button data-tab="live" class="tab px-4 py-2 rounded-2xl text-sm border">Live Order</button>
        {% endif %}
        <button data-tab="rec" class="tab px-4 py-2 rounded-2xl text-sm border">Recommendations</button>
        {% if user.is_authenticated %}
          <button data-tab="txn" class="tab px-4 py-2 rounded-2xl text-sm border">Transactions</button>
          <button data-tab="profile" class="tab px-4 py-2 rounded-2xl text-sm border">Profile</button>
        {% endif %}
      </nav>

      <!-- Right actions -->
      <div class="flex items-center gap-2">
        <a href="{% url 'core:restaurant_signin' %}" class="hidden md:inline-flex rounded-2xl border px-4 py-2 text-sm hover:bg-slate-50">
          Restaurant sign in
        </a>
        {% if user.is_authenticated %}
          <a href="{% url 'core:signout' %}" class="hidden md:inline-flex rounded-2xl border px-4 py-2 text-sm hover:bg-slate-50">
            Sign out
          </a>
        {% else %}
          <a href="{% url 'core:signin' %}?next={{ request.get_full_path|urlencode }}" class="hidden md:inline-flex rounded-2xl border px-4 py-2 text-sm hover:bg-slate-50">
            Sign in
          </a>
        {% endif %}
        <button id="openMobile" aria-label="Open menu" class="md:hidden inline-flex rounded-xl border p-2">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6"  x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Mobile drawer -->
  <div id="drawerWrap" class="fixed inset-0 z-40 md:hidden pointer-events-none" aria-hidden="true">
    <div id="drawerBackdrop" class="absolute inset-0 bg-black/30 opacity-0 transition-opacity"></div>
    <aside id="drawer"
           class="absolute top-0 left-0 h-full w-80 max-w-[85%] bg-white shadow-xl border-r border-slate-200 -translate-x-full transform transition-transform duration-300"
           role="dialog" aria-modal="true">
      <div class="flex items-center justify-between px-4 py-4 border-b">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-2xl bg-slate-900 text-white grid place-items-center font-semibold">DD</div>
          <span class="font-semibold">Dyne</span>
        </div>
        <button id="closeMobile" aria-label="Close menu" class="rounded-xl border p-2">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6"  y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="p-4 space-y-2">
        {% if user.is_authenticated and has_live_order %}
          <button data-tab="live" class="m-tab w-full text-left px-4 py-3 rounded-xl text-base border">Live Order</button>
        {% endif %}
        <button data-tab="rec" class="m-tab w-full text-left px-4 py-3 rounded-xl text-base border">Recommendations</button>
        {% if user.is_authenticated %}
          <button data-tab="txn" class="m-tab w-full text-left px-4 py-3 rounded-xl text-base border">Transactions</button>
          <button data-tab="profile" class="m-tab w-full text-left px-4 py-3 rounded-xl text-base border">Profile</button>
        {% endif %}

        <div class="pt-4 space-y-2">
          <a href="{% url 'core:restaurant_signin' %}" class="w-full rounded-xl border px-4 py-3 text-left hover:bg-slate-50">Restaurant sign in</a>
          {% if user.is_authenticated %}
            <a href="{% url 'core:signout' %}" class="w-full rounded-xl border px-4 py-3 text-left hover:bg-slate-50">Sign out</a>
          {% else %}
            <a href="{% url 'core:signin' %}?next={{ request.get_full_path|urlencode }}" class="w-full rounded-xl border px-4 py-3 text-left hover:bg-slate-50">Sign in</a>
          {% endif %}
        </div>
      </div>
    </aside>
  </div>

  <!-- LIVE ORDER -->
  <main id="panel-live" class="mx-auto max-w-3xl px-4 py-8 hidden">
    <div class="rounded-3xl border bg-white p-6 shadow-sm">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold tracking-tight">Your Live Order</h2>
        <span id="liveServer" class="text-sm text-slate-500"></span>
      </div>

      <div id="liveBody" class="mt-4">
        <div id="liveLoading" class="text-slate-600">Loading your order‚Ä¶</div>
        <div id="liveEmpty" class="hidden text-slate-600">No active ticket found.</div>

        <div id="liveContent" class="hidden">
          <ul id="liveItems" class="divide-y"></ul>

          <div class="mt-4 grid gap-2 text-sm">
            <div class="flex items-center justify-between">
              <span class="text-slate-500">Subtotal</span>
              <span id="liveSubtotal" class="font-medium">$0.00</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-slate-500">Tax</span>
              <span id="liveTax" class="font-medium">$0.00</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-slate-500">Tip</span>
              <span id="liveTip" class="font-medium">$0.00</span>
            </div>

            <div class="flex items-center justify-between border-t pt-2">
              <span class="text-slate-700 font-semibold">Total</span>
              <span id="liveTotal" class="text-lg font-semibold">$0.00</span>
            </div>

            <div class="flex flex-col gap-1 border-t pt-2">
              <div class="flex items-center justify-between">
                <span class="text-slate-700">Amount Due</span>
                <span id="liveDue" class="text-xl font-semibold">$0.00</span>
              </div>

              <!-- Server chat bubble -->
              <div id="serverMessage" class="mt-3 flex justify-start hidden">
                <div class="relative max-w-[85%] rounded-2xl bg-slate-100 px-4 py-3 text-slate-800 shadow-sm">
                  <div class="absolute left-[-6px] top-3 h-4 w-4 bg-slate-100 rotate-45"></div>
                  <p id="serverMessageText" class="text-[15px] leading-snug font-medium"></p>
                  <p id="serverMessageBy" class="mt-1 text-xs text-slate-500"></p>
                </div>
              </div>

              <!-- Tip options -->
              <div class="flex justify-between gap-3 w-full" id="tipButtons">
                <button type="button"
                        class="tipBtn flex-1 py-4 rounded-xl bg-emerald-600 text-white text-base font-semibold"
                        data-tip="18">18%</button>
                <button type="button"
                        class="tipBtn flex-1 py-4 rounded-xl bg-white text-slate-700 text-base font-semibold border"
                        data-tip="20">20%</button>
                <button type="button"
                        class="tipBtn flex-1 py-4 rounded-xl bg-white text-slate-700 text-base font-semibold border"
                        data-tip="22">22%</button>
                <button type="button"
                        class="tipBtn flex-1 py-4 rounded-xl bg-white text-slate-700 text-base font-semibold border"
                        data-tip="custom">Custom</button>
              </div>

              <div id="tipCustomWrap"
                   class="flex items-center justify-end gap-2 hidden">
                <input
                  id="tipCustomPct"
                  type="tel"
                  inputmode="numeric"
                  pattern="[0-9]*"
                  min="0"
                  max="100"
                  class="w-20 rounded-xl border px-2 py-1 text-right text-sm"
                  placeholder="0"
                />
                <span class="text-sm text-slate-500">%</span>
              </div>
            </div>
          </div>

          <div class="mt-6 flex items-center justify-end gap-3">
            <button id="refreshLive" class="rounded-2xl border px-4 py-2 text-sm hover:bg-slate-50">Refresh</button>
            <button id="splitPaymentBtn"
                    type="button"
                    class="rounded-2xl border px-4 py-2 text-sm hover:bg-slate-50">
              Split payment
            </button>
            <button id="closeTabBtn" class="rounded-2xl bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 text-sm">
              Close Out
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- RECOMMENDATIONS -->
  <main id="panel-rec" class="mx-auto max-w-5xl px-4 py-8 hidden">
    <section class="w-full">
      <div class="flex items-start justify-between">
        <div>
          <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">Where everyone‚Äôs eating?</h1>
        </div>
      </div>

      <!-- Map card -->
      <div class="mt-6 rounded-3xl border border-slate-200 bg-white p-4 shadow-sm">
        <div class="flex items-center gap-3">
          <input id="citySearch"
                 placeholder="Search a city (e.g., San Francisco)"
                 class="flex-1 rounded-2xl border px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-slate-300"
                 type="text"
                 autocomplete="off" />
          <button id="clearCity" class="rounded-2xl border px-3 py-2 text-sm hover:bg-slate-50">Clear</button>
        </div>
        <div id="map" class="mt-4 rounded-2xl" style="height: 420px;"></div>
      </div>

      <!-- Rankings list -->
      <div id="rankings" class="mt-6">
        <h2 class="mb-2 text-sm font-semibold text-slate-700">Dyne restaurants near you</h2>
        <ul id="rankList" class="divide-y"></ul>
      </div>

      <!-- Details card (kept so scripts still work) -->
      <section class="mt-6 rounded-3xl border border-slate-200 bg-white p-5 shadow-sm">
        <h2 class="text-lg font-semibold">Details</h2>
        <div id="detailsEmpty" class="mt-2 text-sm text-slate-600">
          Tap any restaurant in the list or on the map to see more info.
        </div>
        <div id="detailsBox" class="mt-4 space-y-2 hidden">
          <div class="text-sm">
            <span class="text-slate-500">Name:</span>
            <span id="dName" class="font-medium"></span>
          </div>
          <div class="text-sm">
            <span class="text-slate-500">Address:</span>
            <span id="dAddr" class="font-medium"></span>
          </div>
          <div class="pt-2">
            <a id="mapsLink"
               target="_blank"
               rel="noreferrer"
               class="inline-flex items-center gap-2 rounded-2xl border px-3 py-2 text-sm hover:bg-slate-50">
              Open in Maps
            </a>
          </div>
        </div>
      </section>

      <!-- How Dyne works / restaurant pitch -->
      <section
        class="mt-10 overflow-hidden rounded-3xl border border-slate-200 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-slate-50 shadow-lg"
      >
        <div class="grid gap-6 lg:grid-cols-2">
          <!-- Left: value props -->
          <div class="p-6 md:p-8">
            <div class="inline-flex items-center gap-2 rounded-full bg-slate-800/80 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.18em] text-emerald-300">
              <span class="h-1.5 w-1.5 rounded-full bg-emerald-400"></span>
              Dyne Network for Restaurants
            </div>

            <h2 class="mt-4 text-2xl md:text-3xl font-extrabold leading-tight">
              Turn every visit into a <span class="text-emerald-300">repeat customer</span>.
            </h2>

            <p class="mt-3 text-sm md:text-base text-slate-200/90">
              Dyne connects your POS to your guests‚Äô phones. Diners see a live receipt, tip, and pay
              from their seat. You see which menu items, nights, and staff actually bring people back.
            </p>

            <div class="mt-5 grid gap-3 md:grid-cols-2">
              <div class="flex items-start gap-3">
                <div class="mt-0.5 h-8 w-8 shrink-0 rounded-full bg-emerald-500/20 grid place-items-center">
                  <span class="text-emerald-300 text-lg">üìç</span>
                </div>
                <div>
                  <h3 class="text-sm font-semibold text-slate-50">Join the Dyne map</h3>
                  <p class="mt-1 text-xs text-slate-200/80">
                    Be featured in the Dyne app so local members can discover and try your restaurant.
                  </p>
                </div>
              </div>

              <div class="flex items-start gap-3">
                <div class="mt-0.5 h-8 w-8 shrink-0 rounded-full bg-emerald-500/20 grid place-items-center">
                  <span class="text-emerald-300 text-lg">üìä</span>
                </div>
                <div>
                  <h3 class="text-sm font-semibold text-slate-50">See what works</h3>
                  <p class="mt-1 text-xs text-slate-200/80">
                    Track which dishes, days, and sections drive the most repeat Dyne visits.
                  </p>
                </div>
              </div>

              <div class="flex items-start gap-3">
                <div class="mt-0.5 h-8 w-8 shrink-0 rounded-full bg-emerald-500/20 grid place-items-center">
                  <span class="text-emerald-300 text-lg">üí≥</span>
                </div>
                <div>
                  <h3 class="text-sm font-semibold text-slate-50">Country-club checkout</h3>
                  <p class="mt-1 text-xs text-slate-200/80">
                    Guests tip and pay from their phone while sitting down. No guessing when they‚Äôre ready for the check.
                  </p>
                </div>
              </div>

              <div class="flex items-start gap-3">
                <div class="mt-0.5 h-8 w-8 shrink-0 rounded-full bg-emerald-500/20 grid place-items-center">
                  <span class="text-emerald-300 text-lg">üîå</span>
                </div>
                <div>
                  <h3 class="text-sm font-semibold text-slate-50">Works with your POS</h3>
                  <p class="mt-1 text-xs text-slate-200/80">
                    Dyne runs alongside your existing POS setup.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Right: flow card -->
          <div class="relative bg-slate-950/40">
            <div class="pointer-events-none absolute -top-20 -right-10 h-56 w-56 rounded-full bg-emerald-500/20 blur-3xl"></div>
            <div class="pointer-events-none absolute bottom-0 left-0 h-40 w-40 rounded-full bg-sky-500/10 blur-3xl"></div>

            <div class="relative h-full p-6 md:p-8 flex flex-col justify-center">
              <div class="rounded-3xl border border-slate-700/70 bg-slate-900/70 p-5">
                <p class="text-xs font-semibold uppercase tracking-[0.16em] text-slate-400">
                  A night with Dyne
                </p>

                <ol class="mt-3 space-y-3 text-xs md:text-sm text-slate-100">
                  <li class="flex gap-3">
                    <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-full bg-slate-800 text-[11px] font-semibold">1</span>
                    <span>Guest gives their Dyne member number when they sit down.</span>
                  </li>
                  <li class="flex gap-3">
                    <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-full bg-slate-800 text-[11px] font-semibold">2</span>
                    <span>Dyne links the table to their phone and shows a live receipt.</span>
                  </li>
                  <li class="flex gap-3">
                    <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-full bg-slate-800 text-[11px] font-semibold">3</span>
                    <span>We send a secure SMS code so they can authenticate and pay.</span>
                  </li>
                  <li class="flex gap-3">
                    <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-full bg-slate-800 text-[11px] font-semibold">4</span>
                    <span>Dyne logs visit + order data so you can see what brings them back.</span>
                  </li>
                </ol>

                <p class="mt-4 text-[11px] leading-snug text-slate-400">
                  <strong>SMS usage:</strong> Dyne only texts guests to verify their identity and send
                  secure links to view their live receipt. No marketing or promotional texts. Message
                  and data rates may apply. Reply <strong>STOP</strong> to opt out or <strong>HELP</strong> for help.
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>
    </section>
  </main>

  {% if user.is_authenticated %}
  <!-- TRANSACTIONS -->
  <main id="panel-txn" class="mx-auto max-w-7xl px-4 py-10 hidden">
    <div class="rounded-3xl border bg-white p-6">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <h2 class="text-2xl font-bold tracking-tight">Your Transactions</h2>
        <div id="txnCount" class="text-sm text-slate-600"></div>
      </div>

      <div id="txnMobile" class="mt-4 md:hidden divide-y"></div>

      <div class="mt-4 overflow-x-auto -mx-4 sm:mx-0" style="-webkit-overflow-scrolling:touch">
        <table class="hidden md:table min-w-full text-sm">
          <thead class="text-left text-slate-500">
            <tr>
              <th class="py-3 pr-4">Date</th>
              <th class="py-3 pr-4">Restaurant</th>
              <th class="py-3 pr-4 hidden lg:table-cell">City</th>
              <th class="py-3 pr-4 text-right">Total</th>
              <th class="py-3 pr-0 text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="txnBody" class="divide-y"></tbody>
        </table>
      </div>
    </div>
  </main>
  {% endif %}

  {% if user.is_authenticated %}
  <!-- PROFILE -->
  <main id="panel-profile" class="mx-auto max-w-3xl px-4 py-10 grid gap-6 hidden">
    <section class="rounded-3xl border bg-white p-6">
      <h2 class="text-xl font-semibold">Member Info</h2>
      <div class="mt-4 flex items-center justify-between">
        <div>
          <div class="text-sm text-slate-500">Member number</div>
          <div id="memberNum" class="text-2xl font-bold tracking-wider">{{ member_number|default:"‚Äî" }}</div>
        </div>
        <button id="copyBtn" class="rounded-2xl border px-4 py-2 text-sm hover:bg-slate-50">Copy</button>
      </div>
    </section>

    <section class="rounded-3xl border bg-white p-6">
      <h2 class="text-xl font-semibold">Card on file</h2>
      <div class="mt-4 flex items-center justify-between">
        <div>
          <div class="text-sm text-slate-500">Default payment method</div>
          <div id="cardLine" class="text-lg font-semibold">
            {% if card_brand and card_last4 %}
              {{ card_brand|title }} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {{ card_last4 }}
            {% else %}
              ‚Äî
            {% endif %}
          </div>
        </div>
        <div class="flex items-center gap-2">
          <a href="{% url 'core:update_card' %}?next=/profile"
             class="rounded-2xl border px-4 py-2 text-sm hover:bg-slate-50">Update</a>
        </div>
      </div>
    </section>
  </main>
  {% endif %}

  <!-- Split Payment Modal -->
  <div id="splitModal"
       class="fixed inset-0 z-[192] hidden"
       role="dialog"
       aria-modal="true"
       aria-labelledby="splitTitle">
    <div id="splitBackdrop" class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 grid place-items-center p-4">
      <div class="w-full max-w-md rounded-3xl bg-white border border-slate-200 shadow-xl p-6">
        <div class="flex items-start justify-between">
          <div>
            <h3 id="splitTitle" class="text-lg font-semibold">Split payment</h3>
            <p class="mt-1 text-sm text-slate-500">
              Add the member numbers for everyone sharing this check.
            </p>
          </div>
          <button id="splitClose"
                  type="button"
                  class="rounded-xl border px-2 py-1 text-sm hover:bg-slate-50">
            Close
          </button>
        </div>

        <div class="mt-4">
          <div id="splitList" class="space-y-2"></div>
          <button id="splitAdd"
                  type="button"
                  class="mt-3 inline-flex items-center rounded-2xl border px-3 py-2 text-sm hover:bg-slate-50">
            + Add another member
          </button>
        </div>

        <div class="mt-6 flex items-center justify-end gap-3">
          <button id="splitCancel"
                  type="button"
                  class="rounded-2xl border px-4 py-2 text-sm hover:bg-slate-50">
            Cancel
          </button>
          <button id="splitDone"
                  type="button"
                  class="rounded-2xl bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 text-sm">
            Done
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Receipt Modal -->
  <div id="receiptModal"
       class="fixed inset-0 z-[190] hidden"
       role="dialog" aria-modal="true" aria-labelledby="rcptTitle">
    <div id="rcptBackdrop" class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 grid place-items-center p-4">
      <div class="w-full max-w-xl rounded-3xl bg-white border border-slate-200 shadow-xl p-6">
        <div class="flex items-start justify-between">
          <div>
            <h3 id="rcptTitle" class="text-lg font-semibold">Receipt</h3>
            <p id="rcptMeta" class="text-sm text-slate-500 mt-1"></p>
          </div>
          <button id="rcptClose"
                  type="button"
                  class="rounded-xl border px-2 py-1 text-sm hover:bg-slate-50"
                  aria-label="Close receipt">
            Close
          </button>
        </div>

        <div id="rcptBody" class="mt-4">
          <div id="rcptLoading" class="text-slate-600">Loading‚Ä¶</div>
          <div id="rcptError" class="hidden text-red-600 text-sm"></div>

          <table id="rcptTable" class="hidden min-w-full text-sm">
            <thead class="text-slate-500 border-b">
              <tr>
                <th class="py-2 text-left">Item</th>
                <th class="py-2 text-right">Qty</th>
                <th class="py-2 text-right">Price</th>
                <th class="py-2 text-right">Line</th>
              </tr>
            </thead>
            <tbody id="rcptItems" class="divide-y"></tbody>
          </table>

          <div id="rcptTotals" class="hidden mt-4 grid gap-1 text-sm">
            <div class="flex items-center justify-between">
              <span class="text-slate-500">Subtotal</span>
              <span id="rcptSub" class="font-medium">$0.00</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-slate-500">Tax</span>
              <span id="rcptTax" class="font-medium">$0.00</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-slate-500">Tip</span>
              <span id="rcptTip" class="font-medium">$0.00</span>
            </div>
            <div class="flex items-center justify-between border-t pt-2">
              <span class="text-slate-700 font-semibold">Paid</span>
              <span id="rcptPaid" class="text-lg font-semibold">$0.00</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="border-t border-slate-200">
    <div class="mx-auto max-w-7xl px-4 py-8 text-center text-sm text-slate-600">
      ¬© <span id="year"></span> Dyne
    </div>
  </footer>


  <script>
    /* ===================== Server/Constants ===================== */
    window.DND_RESTAURANTS = {{ restaurants_json|default:"[]"|safe }};
    const REVIEW_URL = "/api/review/submit"; // already supported in your urls
    const money = c => `$${(Number(c||0)/100).toFixed(2)}`;

    /* ===================== Toast ===================== */
    function showToast(msg, {title="Notice", tone="info"} = {}) {
      document.getElementById("toastTitle").textContent = title;
      document.getElementById("toastMsg").textContent = String(msg || "");
      const toneCls = tone === "error" ? "border-red-200 bg-red-50" :
                      tone === "success" ? "border-emerald-200 bg-emerald-50" :
                      "border-slate-200 bg-white";
      const iconCls = tone === "error" ? "bg-red-400" : tone === "success" ? "bg-emerald-400" : "bg-slate-400";
      const box = document.getElementById("toastBox");
      box.className = `pointer-events-auto max-w-xl w/full rounded-2xl border px-4 py-3 shadow-lg ${toneCls} text-slate-800 flex items-start gap-3`.replace("/","/");
      document.getElementById("toastIcon").className = `mt-[2px] h-5 w-5 rounded-full ${iconCls}`;
      document.getElementById("toast").classList.remove("hidden");
      document.getElementById("toastClose").onclick = () => document.getElementById("toast").classList.add("hidden");
      setTimeout(() => document.getElementById("toast").classList.add("hidden"), 4000);
    }

    /* ===================== Tabs & Drawer ===================== */
    const hasLive  = (document.body.dataset.live === "1");
    const member   = document.body.dataset.member || "";
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    function getTabIds(){ return Array.from(new Set([...$$('[data-tab]')].map(b => b.dataset.tab))); }
    function setTab(next){
      const ids = getTabIds();
      if (!ids.includes(next)) next = hasLive ? 'live' : 'rec';
      $$(".tab").forEach(b => {
        const active = b.dataset.tab === next;
        b.className = "tab px-4 py-2 rounded-2xl text-sm border " + (active ? "bg-slate-900 text-white border-slate-900" : "hover:bg-slate-50");
      });
      $$(".m-tab").forEach(b => {
        const active = b.dataset.tab === next;
        b.className = "m-tab w-full text-left px-4 py-3 rounded-xl text-base border " + (active ? "bg-slate-900 text-white border-slate-900" : "hover:bg-slate-50");
      });
      ids.forEach(id => $("#panel-"+id)?.classList.toggle("hidden", id !== next));
    }
    $$(".tab").forEach(b => b.addEventListener("click", () => setTab(b.dataset.tab)));
    $$(".m-tab").forEach(b => b.addEventListener("click", () => { setTab(b.dataset.tab); openDrawer(false); }));

    function openDrawer(on) {
      const wrap = $("#drawerWrap"), drawer = $("#drawer"), backdrop = $("#drawerBackdrop");
      wrap.classList.toggle("pointer-events-none", !on);
      drawer.style.transform = on ? "translateX(0)" : "translateX(-100%)";
      backdrop.style.opacity = on ? "1" : "0";
    }
    $("#openMobile")?.addEventListener("click", () => openDrawer(true));
    $("#closeMobile")?.addEventListener("click", () => openDrawer(false));
    $("#drawerBackdrop")?.addEventListener("click", () => openDrawer(false));

    /* ===================== Live Order (same behavior) ===================== */
    const POLL_MS_BASE = 8000;
    let firstPaint = true, lastFP = null, timer = null, ctrl  = null;
    window.__lastReceipt = null;

    const moneyInt = v => `$${(v/100).toFixed(2)}`;
    const DEFAULT_TIP_PCT = 20;
let tipPct = DEFAULT_TIP_PCT;

function computeTipCents(rec, pct) {
  const base = (rec.subtotal_cents && rec.subtotal_cents > 0)
    ? rec.subtotal_cents
    : Math.max((rec.total_cents || 0) - (rec.tax_cents || 0), 0);
  const p = Math.max(0, Number(pct) || 0);
  return Math.round(base * (p / 100));
}

function updateTotalsWithTip(rec) {
  // use the passed rec, or fall back to the last receipt
  rec = rec || (window.__lastReceipt || {});

  const tip = computeTipCents(rec, tipPct);
  $("#liveTip").textContent = moneyInt(tip);

  const totalWithTip = (rec.total_cents || 0) + tip;
  const dueWithTip   = (rec.due_cents   || rec.total_cents || 0) + tip;

  $("#liveTotal").textContent = moneyInt(totalWithTip);

  const dueEl = $("#liveDue");
  if (dueEl) dueEl.textContent = moneyInt(dueWithTip);
}



// UI highlighting for tip buttons
function setActiveTipButton(kind) {
  $$(".tipBtn").forEach(btn => {
    const active = btn.dataset.tip === String(kind);

    const base =
      "tipBtn flex-1 py-4 rounded-xl text-base font-semibold border";
    const activePart =
      " bg-emerald-600 text-white border-emerald-600";
    const inactivePart =
      " bg-white text-slate-700 border-slate-200 hover:bg-slate-50";

    btn.className = base + (active ? activePart : inactivePart);
  });
}

    function fingerprint(d){
      const key = JSON.stringify({
        i: (d.items||[]).map(i => [i.name, i.qty, i.cents]),
        s: d.subtotal_cents, t: d.tax_cents, T: d.total_cents, d: d.due_cents
      });
      let h=0; for (let i=0;i<key.length;i++) { h = (h*31 + key.charCodeAt(i))|0; }
      return String(h);
    }
    function renderLive(d){
      window.__lastReceipt = d;
      $("#liveServer").textContent   = d.server || "";
      $("#liveSubtotal").textContent = moneyInt(d.subtotal_cents||0);
      $("#liveTax").textContent      = moneyInt(d.tax_cents||0);
      // Chat bubble message
const msgWrap = $("#serverMessage");
const msgText = $("#serverMessageText");
const msgBy   = $("#serverMessageBy");

if (d.server_message) {
  msgWrap.classList.remove("hidden");
  msgText.textContent = d.server_message;
  msgBy.textContent   = d.server_message_by ? `‚Äì ${d.server_message_by}` : "";
} else {
  msgWrap.classList.add("hidden");
}


      // Totals including currently selected tip
      updateTotalsWithTip(d);

      $("#liveItems").innerHTML = (d.items||[]).map(i => `
        <li class="flex items-center justify-between py-2">
          <span class="truncate">${i.name || ""}</span>
          <span class="tabular-nums text-slate-700">${i.qty} √ó ${moneyInt(i.cents||0)}</span>
        </li>`).join("");
    }
    function showLiveBlocks(state){
      const loading = $("#liveLoading"), content = $("#liveContent"), empty = $("#liveEmpty");
      if (state === "loading-first") { loading?.classList.remove("hidden"); content?.classList.add("hidden"); empty?.classList.add("hidden"); }
      else if (state === "show-content") { loading?.classList.add("hidden"); empty?.classList.add("hidden"); content?.classList.remove("hidden"); }
      else if (state === "empty") { loading?.classList.add("hidden"); content?.classList.add("hidden"); empty?.classList.remove("hidden"); }
    }
    async function fetchReceipt({silent=false} = {}){
      if (!member) { showLiveBlocks("empty"); return; }
      if (ctrl) ctrl.abort();
      ctrl = new AbortController();
      if (firstPaint && !silent) showLiveBlocks("loading-first");
      try {
        const r = await fetch(`/api/member/${encodeURIComponent(member)}/receipt`, { signal: ctrl.signal, cache: "no-store", headers: {"Accept":"application/json"} });
        if (r.status === 404) { showLiveBlocks("empty"); scheduleNext(POLL_MS_BASE); return; }
        const d = await r.json();
        if (!r.ok || !d.ok) throw new Error(d.error || `HTTP ${r.status}`);
        window.__lastReceipt = d;
        if (firstPaint) showLiveBlocks("show-content");
        const fp = fingerprint(d);
        if (fp !== lastFP) { lastFP = fp; renderLive(d); }
        firstPaint = false;
        scheduleNext(POLL_MS_BASE);
      } catch { scheduleNext(Math.min(POLL_MS_BASE * 2, 30000)); }
    }
    function scheduleNext(ms){ clearTimeout(timer); timer = setTimeout(() => fetchReceipt({silent:true}), ms); }
    function getCSRFCookie(){ const m = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/); return m ? decodeURIComponent(m[1]) : ""; }
    $("#refreshLive")?.addEventListener("click", () => fetchReceipt({silent:true}));
// Tip buttons: 15 / 18 / 20 / Custom
(function () {
  const customWrap  = $("#tipCustomWrap");
  const customInput = $("#tipCustomPct");

  // initial highlight (15%)
  setActiveTipButton("20");

  // --- prevent weird keys like e, E, +, -, . on desktop ---
  if (customInput) {
    customInput.addEventListener("keydown", (e) => {
      const blocked = ["e", "E", "+", "-", ".", ",", " "];
      if (blocked.includes(e.key)) {
        e.preventDefault();
      }
    });

    // --- sanitize input to digits only, clamp 0‚Äì100, update totals ---
    customInput.addEventListener("input", () => {
      // strip everything except digits
      let raw = (customInput.value || "").replace(/[^\d]/g, "");

      // max 3 digits
      if (raw.length > 3) raw = raw.slice(0, 3);

      // to number and clamp 0‚Äì100
      let val = parseInt(raw || "0", 10);
      if (isNaN(val)) val = 0;
      if (val > 100) val = 100;

      // write cleaned value back
      customInput.value = val === 0 && raw === "" ? "" : String(val);

      tipPct = val;
      setActiveTipButton("custom");
      updateTotalsWithTip();
    });
  }

  // Buttons (15 / 18 / 20 / Custom)
  $$(".tipBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      const v = btn.dataset.tip;

      if (v === "custom") {
        customWrap?.classList.remove("hidden");
        setActiveTipButton("custom");
        customInput?.focus(); // brings up keypad on phones
        updateTotalsWithTip();
      } else {
        customWrap?.classList.add("hidden");
        tipPct = parseFloat(v) || 0;
        setActiveTipButton(v);
        updateTotalsWithTip();
      }
    });
  });
})();


    $("#closeTabBtn")?.addEventListener("click", async (ev) => {
      const btn = ev.currentTarget; btn.disabled = true;
      try {
        if (!member) { showToast("No member found. Please sign in again.", {tone:"error"}); return; }
        if (!window.__lastReceipt) { showToast("No live receipt yet. Try Refresh.", {tone:"error"}); return; }
        const rec = window.__lastReceipt || {};
        const tip_cents = computeTipCents(rec, tipPct);

        const resp = await fetch(`/api/member/${encodeURIComponent(member)}/close`, {
          method: "POST",
          headers: {"Accept":"application/json","Content-Type":"application/json","X-CSRFToken": getCSRFCookie()},
          credentials: "same-origin",
          body: JSON.stringify({ tip_cents, reference: "customer-close" })
        });
        const text = await resp.text(); let data = null; try { data = JSON.parse(text); } catch {}
        if (!resp.ok || data?.ok === false) { showToast(`Close out failed: ${(data?.error || text||'').toString().slice(0,180)}`, {tone:"error"}); return; }
        showToast("Closed out & receipt updated.", {tone:"success"});
        firstPaint = true; lastFP = null; await fetchReceipt({silent:false});
        if (data?.review?.restaurant_id) openReviewModal(data.review);
      } catch { showToast("Network error while closing.", {tone:"error"}); } finally { btn.disabled = false; }
    });
    document.addEventListener("visibilitychange", () => { if (document.hidden) { clearTimeout(timer); if (ctrl) ctrl.abort(); } else { fetchReceipt({silent:true}); } });

 /* ===================== Recommendations (markers + bounds + city search) ===================== */
(function () {
  const markerById = new Map();
  let gmap, geocoder, infoWin;
  let markers = [];

  // Normalize each restaurant object
  function normalizeRestaurant(rec, i = 0) {
    const lat = rec.lat ?? rec.latitude ?? null;
    const lng = rec.lng ?? rec.longitude ?? null;
    return {
      id: rec.id ?? i + 1,
      name: rec.name || "",
      address: rec.address || "",
      city: rec.city || "",
      tx: rec.tx ?? 0,
      lat, lng,
    };
  }

  function getCombinedRestaurants() {
    const db = Array.isArray(window.DND_RESTAURANTS) ? window.DND_RESTAURANTS : [];
    return db.map(normalizeRestaurant);
  }

  // Simple cache wrapper for geocodes
  function cacheKey(addr) { return `geo:${addr}`; }
  async function geocodeAddress(addr) {
    return new Promise((resolve) => {
      geocoder.geocode({ address: addr }, (results, status) => {
        if (status === "OK" && results[0]) {
          const loc = results[0].geometry.location;
          resolve({ lat: loc.lat(), lng: loc.lng() });
        } else {
          resolve(null);
        }
      });
    });
  }
  async function ensureLatLng(r) {
    if (r.lat != null && r.lng != null) return r;
    if (!r.address) return r;
    const key = cacheKey(r.address);
    const cached = sessionStorage.getItem(key);
    if (cached) {
      try { const pt = JSON.parse(cached); r.lat = pt.lat; r.lng = pt.lng; return r; } catch {}
    }
    const pt = await geocodeAddress(r.address);
    if (pt) { r.lat = pt.lat; r.lng = pt.lng; try { sessionStorage.setItem(key, JSON.stringify(pt)); } catch {} }
    return r;
  }

  function clearMarkers() {
    markers.forEach(m => m.setMap(null));
    markers = [];
    markerById.clear();
  }

  function addMarker(r) {
    const m = new google.maps.Marker({
      map: gmap,
      position: { lat: r.lat, lng: r.lng },
      title: r.name || "",
    });
    m.__data = r;
    markers.push(m);
    markerById.set(String(r.id), m);

    m.addListener("click", () => {
      const html = `
        <div style="min-width:220px">
          <div style="font-weight:600">${r.name || ""}</div>
          <div style="color:#64748b;font-size:12px">${r.address || ""}</div>
          <div style="margin-top:8px">
            <a target="_blank" rel="noreferrer"
               href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.address||"")}"
               style="text-decoration:underline">Open in Google Maps</a>
          </div>
        </div>`;
      if (!infoWin) infoWin = new google.maps.InfoWindow();
      infoWin.setContent(html);
      infoWin.open(gmap, m);

      // Fill the Details panel on the right
      document.getElementById("detailsEmpty")?.classList.add("hidden");
      document.getElementById("detailsBox")?.classList.remove("hidden");
      document.getElementById("dName").textContent = r.name || "";
      document.getElementById("dAddr").textContent = r.address || "";
      document.getElementById("dTx").textContent   = r.tx ?? "-";
      document.getElementById("mapsLink").href     = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.address||"")}`;
    });
  }

  // Fit bounds but cap the resulting zoom so it never starts too close
  function fitBoundsCapped(bounds, maxZoom = 12) {
    google.maps.event.addListenerOnce(gmap, "idle", () => {
      if (gmap.getZoom() > maxZoom) gmap.setZoom(maxZoom);
    });
    gmap.fitBounds(bounds);
  }

  async function buildMarkers(list) {
    clearMarkers();
    const bounds = new google.maps.LatLngBounds();
    for (let r of list) {
      r = await ensureLatLng(r);
      if (r.lat == null || r.lng == null) continue;
      addMarker(r);
      bounds.extend({ lat: r.lat, lng: r.lng });
    }
    if (!bounds.isEmpty()) fitBoundsCapped(bounds, 12);
  }

  function getVisibleRestaurants() {
    const b = gmap?.getBounds(); if (!b) return [];
    const visible = [];
    for (const m of markers) if (b.contains(m.getPosition())) visible.push(m.__data);
    visible.sort((a,b) => (b.tx||0) - (a.tx||0) || a.name.localeCompare(b.name));
    return visible;
  }

  function renderRecFor(items) {
    const ul = document.getElementById("rankList"); if (!ul) return;
    ul.innerHTML = "";
    if (!items.length) {
      ul.innerHTML = `<li class="py-6 text-center text-slate-500">No restaurants in view ‚Äî pan or zoom the map.</li>`;
      return;
    }
    const maxTx = items.reduce((m,r)=>Math.max(m, r.tx||0), 1);
    items.forEach((r,i) => {
      const pct = Math.round(((r.tx||0)/maxTx)*100);
      const li = document.createElement("li");
      li.className = "py-3";
      li.innerHTML = `
        <button class="w-full text-left rounded-2xl p-3 border bg-white/70 hover:bg-white hover:shadow-sm transition"
                data-id="${r.id}">
          <div class="flex items-center justify-between gap-3">
            <div class="flex items-center gap-3 min-w-0">
              <div class="w-9 h-9 rounded-full grid place-items-center text-sm font-bold bg-slate-900 text-white">${i+1}</div>
              <div class="min-w-0">
                <div class="font-semibold truncate">${r.name || "‚Äî"}</div>
                <div class="text-xs text-slate-500 truncate">${r.address || ""}</div>
              </div>
            </div>
          </div>
        </button>`;
      ul.appendChild(li);
    });

    // Clicking a list row focuses the corresponding marker
    ul.onclick = (e) => {
      const btn = e.target.closest("button[data-id]"); if (!btn) return;
      const m = markerById.get(String(btn.dataset.id)); if (!m) return;
      google.maps.event.trigger(m, "click");
      gmap.panTo(m.getPosition());
    };
  }

  function syncListWithMap() { renderRecFor(getVisibleRestaurants()); }

  function setupPlacesAutocomplete() {
    const input = document.getElementById("citySearch");
    if (!input || !google.maps.places) return;
    const ac = new google.maps.places.Autocomplete(input, { types: ["(cities)"] });
    ac.addListener("place_changed", () => {
      const place = ac.getPlace();
      if (place?.geometry?.viewport) {
        fitBoundsCapped(place.geometry.viewport, 12); // cap zoom after city fit
      } else if (place?.geometry?.location) {
        gmap.setCenter(place.geometry.location);
        gmap.setZoom(12);
      }
    });
    document.getElementById("clearCity")?.addEventListener("click", () => { input.value = ""; syncListWithMap(); });
  }

  // Google callback (called by the loader tag)
  window.initDndMap = async function initDndMap() {
    if (!window.google || !google.maps) { renderRecFor(getCombinedRestaurants()); return; }
    geocoder = new google.maps.Geocoder();
    gmap = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 39.5, lng: -98.35 }, // USA
      zoom: 4,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: true,
    });

    setupPlacesAutocomplete();

    const items = getCombinedRestaurants();
    await buildMarkers(items);      // geocodes as needed + adds markers + fits bounds (capped)
    syncListWithMap();
    gmap.addListener("idle", syncListWithMap);
  };
})();
// ===================== Receipt loader (restored) =====================
async function loadReceipt(tlId){
  document.getElementById("rcptTitle").textContent = "Receipt";
  document.getElementById("rcptMeta").textContent = "";
  document.getElementById("rcptLoading").classList.remove("hidden");
  document.getElementById("rcptError").classList.add("hidden");
  document.getElementById("rcptTable").classList.add("hidden");
  document.getElementById("rcptTotals").classList.add("hidden");
  document.getElementById("rcptItems").innerHTML = "";
  openReceiptModal();

  try {
    const r = await fetch(`/api/tickets/${encodeURIComponent(tlId)}`, {
      headers: { "Accept": "application/json" },
      cache: "no-store"
    });
    const d = await r.json().catch(() => ({}));
    if (!r.ok || !d.ok) throw new Error(d.error || `HTTP ${r.status}`);

    document.getElementById("rcptTitle").textContent = d.restaurant || "Receipt";
    const when = d.closed_at ? new Date(d.closed_at) : null;
    const parts = [
      d.ticket_number ? `Ticket #${d.ticket_number}` : "",
      d.server ? `Server: ${d.server}` : "",
      when ? when.toLocaleString() : ""
    ].filter(Boolean);
    document.getElementById("rcptMeta").textContent = parts.join(" ¬∑ ");

    const tbody = document.getElementById("rcptItems");
    (d.items || []).forEach(it => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="py-2 pr-3">${it.name || ""}</td>
        <td class="py-2 pr-3 text-right">${it.qty || 1}</td>
        <td class="py-2 pr-3 text-right">${money(it.unit_cents || 0)}</td>
        <td class="py-2 text-right font-medium">${money(it.line_total_cents || 0)}</td>`;
      tbody.appendChild(tr);
    });

    document.getElementById("rcptSub").textContent  = money(d.subtotal_cents || 0);
    document.getElementById("rcptTax").textContent  = money(d.tax_cents || 0);
    document.getElementById("rcptTip").textContent  = money(d.tip_cents || 0);
    document.getElementById("rcptPaid").textContent = money(d.paid_cents || 0);

    document.getElementById("rcptLoading").classList.add("hidden");
    document.getElementById("rcptTable").classList.remove("hidden");
    document.getElementById("rcptTotals").classList.remove("hidden");
  } catch {
    document.getElementById("rcptLoading").classList.add("hidden");
    const err = document.getElementById("rcptError");
    err.textContent = "Could not load receipt.";
    err.classList.remove("hidden");
  }
}

    /* ===================== REVIEW MODAL (single implementation) ===================== */
    function ensureReviewModal(){
      if (document.getElementById("reviewModal")) return;
      const div = document.createElement("div");
      div.id = "reviewModal";
      div.className = "fixed inset-0 z-[200] hidden";
      div.innerHTML = `
        <div class="absolute inset-0 bg-black/40"></div>
        <div class="absolute inset-0 grid place-items-center p-4">
          <div class="w-full max-w-md rounded-3xl bg-white shadow-xl border border-slate-200 p-6">
            <div class="flex items-start justify-between">
              <h3 class="text-lg font-semibold">Rate your experience</h3>
              <button id="rvClose" class="rounded-xl border px-2 py-1 text-sm hover:bg-slate-50">Close</button>
            </div>
            <div class="mt-1 text-sm text-slate-600" id="rvTitle"></div>
            <div class="mt-5 flex items-center gap-2" id="rvStars" role="radiogroup" aria-label="Rating out of 5">
              ${[1,2,3,4,5].map(n => `
                <button type="button" class="rv-star w-10 h-10 rounded-full grid place-items-center border text-2xl select-none"
                        data-star="${n}" aria-label="${n} star" aria-checked="false">‚òÖ</button>`).join("")}
            </div>
            <textarea id="rvComment" rows="4" class="mt-5 w-full rounded-2xl border px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-slate-300" placeholder="Optional comment"></textarea>
            <div class="mt-5 flex items-center justify-end gap-3">
              <button id="rvSkip" class="rounded-2xl border px-4 py-2 text-sm hover:bg-slate-50">Skip</button>
              <button id="rvSubmit" class="rounded-2xl bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 text-sm disabled:opacity-50" disabled>Submit</button>
            </div>
          </div>
        </div>`;
      document.body.appendChild(div);

      let hoverStar = 0, chosenStar = 0;
      function paintStars(n, highlight="#facc15"){
        $$(".rv-star").forEach(btn => {
          const val = +btn.dataset.star;
          const on = val <= n;
          btn.style.backgroundColor = on ? highlight : "";
          btn.style.borderColor = on ? "#eab308" : "";
          btn.style.color = on ? "#ffffff" : "";
          btn.setAttribute("aria-checked", String(val === chosenStar));
        });
        $("#rvSubmit").disabled = !(chosenStar >= 1 && chosenStar <= 5);
      }
      $("#rvStars").addEventListener("mouseover", (e) => { const b = e.target.closest(".rv-star"); if (!b) return; hoverStar = +b.dataset.star; paintStars(hoverStar); });
      $("#rvStars").addEventListener("mousemove", (e) => { const b = e.target.closest(".rv-star"); if (!b) return; const v = +b.dataset.star; if (v !== hoverStar) { hoverStar = v; paintStars(hoverStar); } });
      $("#rvStars").addEventListener("mouseleave", () => paintStars(chosenStar));
      $("#rvStars").addEventListener("click", (e) => { const b = e.target.closest(".rv-star"); if (!b) return; chosenStar = +b.dataset.star; paintStars(chosenStar); });
      $("#rvClose").addEventListener("click", () => { $("#reviewModal").classList.add("hidden"); });
      $("#rvSkip").addEventListener("click", () => { $("#reviewModal").classList.add("hidden"); });

      $("#rvSubmit").addEventListener("click", async () => {
        const payload = {
          restaurant_id: +($("#reviewModal").dataset.restId || 0),
          ticket_link_id: +($("#reviewModal").dataset.tlId || 0) || null,
          stars: chosenStar,
          comment: ($("#rvComment").value || "").trim(),
        };
        if (!(payload.restaurant_id && payload.stars >= 1 && payload.stars <= 5)) return;
        try {
          const r = await fetch(REVIEW_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFCookie() },
            body: JSON.stringify(payload)
          });
          const d = await r.json().catch(()=>({}));
          if (r.ok && d.ok) { showToast("Thanks for the review!", {tone:"success"}); $("#reviewModal").classList.add("hidden"); }
          else { showToast(d.error || "Review failed.", {tone:"error"}); }
        } catch { showToast("Network error submitting review.", {tone:"error"}); }
      });

      div.__setContext = ({restaurant_id, restaurant_name, ticket_link_id}) => {
        $("#rvTitle").textContent = restaurant_name ? `How was ${restaurant_name}?` : "How was your order?";
        $("#reviewModal").dataset.restId = restaurant_id || "";
        $("#reviewModal").dataset.tlId = ticket_link_id || "";
        $("#rvComment").value = "";
        hoverStar = 0; chosenStar = 0; paintStars(0);
      };
    }
    function openReviewModal(ctx){ ensureReviewModal(); const el = $("#reviewModal"); el.__setContext?.(ctx || {}); el.classList.remove("hidden"); }

    /* ===================== TRANSACTIONS: real data + actions ===================== */
    const fmtDate = iso => { if (!iso) return "‚Äî"; try { const d = new Date(iso); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; } catch { return "‚Äî"; } };

async function renderTxn(){
  const body    = document.getElementById("txnBody");
  const mobile  = document.getElementById("txnMobile");
  const count   = document.getElementById("txnCount");
  if (!body || !mobile || !count) return;

  body.innerHTML = ""; mobile.innerHTML = ""; count.textContent = "";

  try {
    const r = await fetch("/api/me/transactions", {headers: {"Accept":"application/json"}, cache:"no-store"});
    const data = await r.json().catch(()=> ({}));
    if (!r.ok || !data.ok) throw new Error(data.error || `HTTP ${r.status}`);

    const rows = data.results || [];
    count.textContent = `${rows.length} total`;

    // ===== Desktop table rows (no Subtotal/Tip) =====
    rows.forEach(t => {
      const tip  = t.tip_cents || 0;
      const paid = t.paid_cents || (t.total_cents||0) + tip;

      const tr = document.createElement("tr");
      tr.className = "hover:bg-slate-50";
      tr.innerHTML = `
        <td class="py-3 pr-4">${fmtDate(t.closed_at)}</td>
        <td class="py-3 pr-4">${t.restaurant_name}</td>
        <td class="py-3 pr-4 hidden lg:table-cell">${t.restaurant_city || ""}</td>
        <td class="py-3 pr-4 text-right font-semibold">${money(paid)}</td>
<td class="py-3 pr-0 text-right">
  <button
    class="btn-receipt inline-flex items-center justify-center rounded-2xl border border-slate-900 bg-slate-900 text-white px-4 py-2 text-sm md:text-base md:px-5 md:py-2.5 font-semibold min-w-[110px] hover:bg-slate-800 active:translate-y-[1px] focus:outline-none focus:ring-2 focus:ring-slate-400"
    data-tl="${t.ticket_link_id}">
    Receipt
  </button>
  <button
    class="btn-review inline-flex items-center justify-center rounded-2xl border border-slate-300 bg-white text-slate-900 px-4 py-2 text-sm md:text-base md:px-5 md:py-2.5 font-semibold min-w-[110px] hover:bg-slate-50 active:translate-y-[1px] focus:outline-none focus:ring-2 focus:ring-slate-300 ml-2"
    data-tl="${t.ticket_link_id}" data-rid="${t.restaurant_id}" data-rname="${t.restaurant_name}">
    Review
  </button>
</td>`;
      body.appendChild(tr);
    });

    // ===== Mobile cards (no Subtotal/Tip line) =====
    mobile.innerHTML = rows.map(t => {
      const tip  = t.tip_cents || 0;
      const paid = t.paid_cents || (t.total_cents||0) + tip;

      return `
        <div class="py-4">
          <div class="flex items-center justify-between">
            <div class="text-xs text-slate-500">${fmtDate(t.closed_at)}</div>
            <div class="font-semibold">${money(paid)}</div>
          </div>
          <div class="mt-1 text-sm font-medium">${t.restaurant_name}</div>
          <div class="text-xs text-slate-500">${t.restaurant_city || ""}</div>
<div class="mt-3 flex gap-2">
  <button
    class="btn-receipt inline-flex items-center justify-center rounded-2xl border border-slate-900 bg-slate-900 text-white px-4 py-2 text-sm font-semibold min-w-[110px] hover:bg-slate-800 active:translate-y-[1px] focus:outline-none focus:ring-2 focus:ring-slate-400"
    data-tl="${t.ticket_link_id}">
    Receipt
  </button>
  <button
    class="btn-review inline-flex items-center justify-center rounded-2xl border border-slate-300 bg-white text-slate-900 px-4 py-2 text-sm font-semibold min-w-[110px] hover:bg-slate-50 active:translate-y-[1px] focus:outline-none focus:ring-2 focus:ring-slate-300"
    data-tl="${t.ticket_link_id}" data-rid="${t.restaurant_id}" data-rname="${t.restaurant_name}">
    Review
  </button>
</div>
`;
    }).join("");

  } catch {
    count.textContent = "0 total";
  }

  // Single click handler works for both table & cards
  const container = document.getElementById("panel-txn");
  container.onclick = async (ev) => {
    const rBtn = ev.target.closest(".btn-receipt");
    const vBtn = ev.target.closest(".btn-review");
    if (rBtn) {
      loadReceipt(rBtn.dataset.tl);
    } else if (vBtn) {
      const tlId  = +vBtn.dataset.tl;
      const rid   = +vBtn.dataset.rid;
      const rname = vBtn.dataset.rname || "";
      try {
        const resp = await fetch(`/api/reviews/for-ticket/${encodeURIComponent(tlId)}`, {cache:"no-store"});
        const js = await resp.json().catch(()=> ({}));
        openReviewModal({ restaurant_id: rid, restaurant_name: rname, ticket_link_id: tlId });
        if (resp.ok && js.ok && js.review) {
          const txt = document.getElementById("rvComment");
          if (txt) txt.value = js.review.comment || "";
          const starBtn = document.querySelector(`.rv-star[data-star="${js.review.stars|0}"]`);
          if (starBtn) starBtn.click();
        }
      } catch {
        openReviewModal({ restaurant_id: rid, restaurant_name: rname, ticket_link_id: tlId });
      }
    }
  };
}



    /* ===================== Receipt Modal HTML (static) ===================== */
  </script>
<!-- Split Payment Modal -->
<div id="splitModal"
     class="fixed inset-0 z-[192] hidden"
     role="dialog"
     aria-modal="true"
     aria-labelledby="splitTitle">
  <!-- backdrop -->
  <div id="splitBackdrop" class="absolute inset-0 bg-black/40"></div>

  <div class="absolute inset-0 grid place-items-center p-4">
    <div class="w-full max-w-md rounded-3xl bg-white border border-slate-200 shadow-xl p-6">
      <div class="flex items-start justify-between">
        <div>
          <h3 id="splitTitle" class="text-lg font-semibold">Split payment</h3>
          <p class="mt-1 text-sm text-slate-500">
            Add the member numbers for everyone sharing this check.
          </p>
        </div>
        <button id="splitClose"
                type="button"
                class="rounded-xl border px-2 py-1 text-sm hover:bg-slate-50">
          Close
        </button>
      </div>

      <div class="mt-4">
        <div id="splitList" class="space-y-2">
          <!-- rows will be injected here -->
        </div>

        <button id="splitAdd"
                type="button"
                class="mt-3 inline-flex items-center rounded-2xl border px-3 py-2 text-sm hover:bg-slate-50">
          + Add another member
        </button>
      </div>

      <div class="mt-6 flex items-center justify-end gap-3">
        <button id="splitCancel"
                type="button"
                class="rounded-2xl border px-4 py-2 text-sm hover:bg-slate-50">
          Cancel
        </button>
        <button id="splitDone"
                type="button"
                class="rounded-2xl bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 text-sm">
          Done
        </button>
      </div>
    </div>
  </div>
</div>


  <!-- Receipt Modal (static, simple) -->
<div id="receiptModal"
     class="fixed inset-0 z-[190] hidden"
     role="dialog" aria-modal="true" aria-labelledby="rcptTitle">
  <!-- backdrop -->
  <div id="rcptBackdrop" class="absolute inset-0 bg-black/40"></div>

  <div class="absolute inset-0 grid place-items-center p-4">
    <div class="w-full max-w-xl rounded-3xl bg-white border border-slate-200 shadow-xl p-6">
      <div class="flex items-start justify-between">
        <div>
          <h3 id="rcptTitle" class="text-lg font-semibold">Receipt</h3>
          <p id="rcptMeta" class="text-sm text-slate-500 mt-1"></p>
        </div>
        <button id="rcptClose"
                type="button"
                class="rounded-xl border px-2 py-1 text-sm hover:bg-slate-50"
                aria-label="Close receipt">
          Close
        </button>
      </div>

      <div id="rcptBody" class="mt-4">
        <div id="rcptLoading" class="text-slate-600">Loading‚Ä¶</div>
        <div id="rcptError" class="hidden text-red-600 text-sm"></div>

        <table id="rcptTable" class="hidden min-w-full text-sm">
          <thead class="text-slate-500 border-b">
            <tr>
              <th class="py-2 text-left">Item</th>
              <th class="py-2 text-right">Qty</th>
              <th class="py-2 text-right">Price</th>
              <th class="py-2 text-right">Line</th>
            </tr>
          </thead>
          <tbody id="rcptItems" class="divide-y"></tbody>
        </table>

        <div id="rcptTotals" class="hidden mt-4 grid gap-1 text-sm">
          <div class="flex items-center justify-between">
            <span class="text-slate-500">Subtotal</span>
            <span id="rcptSub" class="font-medium">$0.00</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-slate-500">Tax</span>
            <span id="rcptTax" class="font-medium">$0.00</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-slate-500">Tip</span>
            <span id="rcptTip" class="font-medium">$0.00</span>
          </div>
          <div class="flex items-center justify-between border-t pt-2">
            <span class="text-slate-700 font-semibold">Paid</span>
            <span id="rcptPaid" class="text-lg font-semibold">$0.00</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
/* Bind close behavior AFTER the modal exists */
(function () {
  const modal    = document.getElementById('receiptModal');
  const closeBtn = document.getElementById('rcptClose');
  const backdrop = document.getElementById('rcptBackdrop');

  // Fallback-safe close/open (won't overwrite if already defined elsewhere)
  const close = window.closeReceiptModal || function () {
    modal.classList.add('hidden');
  };
  const open = window.openReceiptModal || function () {
    modal.classList.remove('hidden');
    // focus the close button for accessibility
    closeBtn?.focus({ preventScroll: true });
  };

  window.closeReceiptModal = close;
  window.openReceiptModal  = open;

  closeBtn?.addEventListener('click', close);
  backdrop?.addEventListener('click', close);
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) close();
  });
})();
</script>
  <script>
    /* ===================== Init ===================== */
    document.addEventListener("DOMContentLoaded", () => {
      const y = document.getElementById("year"); if (y) y.textContent = new Date().getFullYear();
      setTab(hasLive ? "live" : "rec");
      renderTxn();
      if (hasLive) fetchReceipt({silent:false});
      // copy member number
      document.getElementById("copyBtn")?.addEventListener("click", async () => {
        try { await navigator.clipboard.writeText(document.getElementById("memberNum")?.textContent?.trim() || ""); showToast("Copied!", {tone:"success"}); } catch { showToast("Could not copy.", {tone:"error"}); }
      });
    });
  </script>


  <!-- Google Maps loader (optional; safe no-op if key missing) -->
  <script async src="https://maps.googleapis.com/maps/api/js?key={{ maps_api_key }}&libraries=places&callback=initDndMap"></script>
<script>
/* ===================== Split Payment Modal ===================== */
(function () {
  const modal     = document.getElementById("splitModal");
  if (!modal) return;

  const backdrop  = document.getElementById("splitBackdrop");
  const openBtn   = document.getElementById("splitPaymentBtn");
  const closeBtn  = document.getElementById("splitClose");
  const cancelBtn = document.getElementById("splitCancel");
  const doneBtn   = document.getElementById("splitDone");
  const addBtn    = document.getElementById("splitAdd");
  const list      = document.getElementById("splitList");

  function addRow(value = "") {
    const row = document.createElement("div");
    row.className = "flex gap-2";
    row.innerHTML = `
      <input
        type="text"
        class="flex-1 rounded-2xl border px-3 py-2 text-sm"
        placeholder="Member number"
        value="${value}"
      />
      <button type="button"
              class="split-remove rounded-2xl border px-3 py-2 text-xs hover:bg-slate-50">
        Remove
      </button>
    `;
    list.appendChild(row);
  }

  function ensureAtLeastOneRow() {
    if (!list.children.length) addRow();
  }

  function open() {
    ensureAtLeastOneRow();
    modal.classList.remove("hidden");
    const firstInput = list.querySelector("input");
    firstInput?.focus({ preventScroll: true });
  }

  function close() {
    modal.classList.add("hidden");
    // you could clear values here if you want, but leaving them
    // makes it feel less destructive if they re-open
  }

  openBtn?.addEventListener("click", open);
  closeBtn?.addEventListener("click", close);
  cancelBtn?.addEventListener("click", close);
  doneBtn?.addEventListener("click", close);
  backdrop?.addEventListener("click", close);

  addBtn?.addEventListener("click", () => addRow());

  // handle remove buttons on any row (event delegation)
  list.addEventListener("click", (e) => {
    const btn = e.target.closest(".split-remove");
    if (!btn) return;
    const row = btn.closest(".flex");
    row?.remove();
    ensureAtLeastOneRow();
  });

  // ESC key to close
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !modal.classList.contains("hidden")) {
      close();
    }
  });
})();
</script>

</body>
</html>