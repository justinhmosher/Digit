{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dine N Dash — Customer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body
  class="min-h-screen bg-gradient-to-b from-white to-slate-50 text-slate-900"
  data-live="{{ has_live_order|yesno:'1,0' }}"
  data-member="{{ member_number|default_if_none:'' }}"
>
  <!-- Toast -->
  <div id="toast" class="pointer-events-none fixed inset-x-0 top-3 z-[100] flex justify-center px-4 hidden">
    <div id="toastBox"
         class="pointer-events-auto max-w-xl w-full rounded-2xl border border-slate-200 px-4 py-3 shadow-lg bg-white text-slate-800 flex items-start gap-3">
      <div id="toastIcon" class="mt-[2px] h-5 w-5 rounded-full bg-slate-400"></div>
      <div class="flex-1">
        <div id="toastTitle" class="font-semibold">Notice</div>
        <div id="toastMsg" class="text-sm mt-0.5"></div>
      </div>
      <button id="toastClose" class="ml-3 rounded-xl border px-2 py-1 text-xs hover:bg-slate-50">Dismiss</button>
    </div>
  </div>

<!-- Header -->
<header class="sticky top-0 z-30 border-b border-slate-200 bg-white/80 backdrop-blur">
  <div class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between">
    <a href="/" class="flex items-center gap-3">
      <div class="h-9 w-9 rounded-2xl bg-slate-900 text-white grid place-items-center font-semibold">DD</div>
      <span class="font-semibold tracking-tight">Dine N Dash</span>
    </a>

    <!-- Desktop tabs (center) -->
    <nav class="hidden md:flex items-center gap-1">
      {% if user.is_authenticated and has_live_order %}
        <button data-tab="live" class="tab px-4 py-2 rounded-2xl text-sm border">Live Order</button>
      {% endif %}
      <button data-tab="rec" class="tab px-4 py-2 rounded-2xl text-sm border">Recommendations</button>
      {% if user.is_authenticated %}
        <button data-tab="txn" class="tab px-4 py-2 rounded-2xl text-sm border">Transactions</button>
        <button data-tab="profile" class="tab px-4 py-2 rounded-2xl text-sm border">Profile</button>
      {% endif %}
    </nav>

    <!-- Right actions -->
    <div class="flex items-center gap-2">
      <a href="{% url 'core:restaurant_signin' %}"
         class="hidden md:inline-flex rounded-2xl border px-4 py-2 text-sm hover:bg-slate-50">
        Restaurant sign in
      </a>

      {% if user.is_authenticated %}
        <a href="{% url 'core:signout' %}"
           class="hidden md:inline-flex rounded-2xl border px-4 py-2 text-sm hover:bg-slate-50">
          Sign out
        </a>
      {% else %}
        <a href="{% url 'core:signin' %}?next={{ request.get_full_path|urlencode }}"
           class="hidden md:inline-flex rounded-2xl border px-4 py-2 text-sm hover:bg-slate-50">
          Sign in
        </a>
      {% endif %}

      <button id="openMobile" aria-label="Open menu" class="md:hidden inline-flex rounded-xl border p-2">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>
</header>

  <!-- Mobile drawer -->
  <div id="drawerWrap" class="fixed inset-0 z-40 md:hidden pointer-events-none" aria-hidden="true">
    <div id="drawerBackdrop" class="absolute inset-0 bg-black/30 opacity-0 transition-opacity"></div>
    <aside id="drawer"
           class="absolute top-0 left-0 h-full w-80 max-w-[85%] bg-white shadow-xl border-r border-slate-200
                  -translate-x-full transform transition-transform duration-300"
           role="dialog" aria-modal="true">
      <div class="flex items-center justify-between px-4 py-4 border-b">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-2xl bg-slate-900 text-white grid place-items-center font-semibold">DD</div>
          <span class="font-semibold">Dine N Dash</span>
        </div>
        <button id="closeMobile" aria-label="Close menu" class="rounded-xl border p-2">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="p-4 space-y-2">
        {% if user.is_authenticated and has_live_order %}
          <button data-tab="live" class="m-tab w-full text-left px-4 py-3 rounded-xl text-base border">Live Order</button>
        {% endif %}
        <button data-tab="rec" class="m-tab w-full text-left px-4 py-3 rounded-xl text-base border">Recommendations</button>
        {% if user.is_authenticated %}
          <button data-tab="txn" class="m-tab w-full text-left px-4 py-3 rounded-xl text-base border">Transactions</button>
          <button data-tab="profile" class="m-tab w-full text-left px-4 py-3 rounded-xl text-base border">Profile</button>
        {% endif %}

        <div class="pt-4 space-y-2">
          <a href="{% url 'core:restaurant_signin' %}" class="w-full rounded-xl border px-4 py-3 text-left hover:bg-slate-50">
            Restaurant sign in
          </a>
          {% if user.is_authenticated %}
            <a href="{% url 'core:signout' %}" class="w-full rounded-xl border px-4 py-3 text-left hover:bg-slate-50">
              Sign out
            </a>
          {% else %}
            <a href="{% url 'core:signin' %}?next={{ request.get_full_path|urlencode }}" class="w-full rounded-xl border px-4 py-3 text-left hover:bg-slate-50">
              Sign in
            </a>
          {% endif %}
        </div>
      </div>
    </aside>
  </div>

  <!-- LIVE ORDER -->
  <main id="panel-live" class="mx-auto max-w-3xl px-4 py-8 hidden">
    <div class="rounded-3xl border bg-white p-6 shadow-sm">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold tracking-tight">Your Live Order</h2>
        <span id="liveServer" class="text-sm text-slate-500"></span>
      </div>

      <div id="liveBody" class="mt-4">
        <div id="liveLoading" class="text-slate-600">Loading your order…</div>
        <div id="liveEmpty" class="hidden text-slate-600">No active ticket found.</div>

        <div id="liveContent" class="hidden">
          <ul id="liveItems" class="divide-y"></ul>

          <div class="mt-4 grid gap-2 text-sm">
            <div class="flex items-center justify-between">
              <span class="text-slate-500">Subtotal</span>
              <span id="liveSubtotal" class="font-medium">$0.00</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-slate-500">Tax</span>
              <span id="liveTax" class="font-medium">$0.00</span>
            </div>
            <div class="flex items-center justify-between">
              <label for="tipPct" class="text-slate-500">Tip</label>
              <div class="flex items-center gap-2">
                <input id="tipPct" type="number" min="0" max="100" step="1" value="15"
                       class="w-16 rounded-xl border px-2 py-1 text-right"> <span>%</span>
                <span id="liveTipAmt" class="font-medium">$0.00</span>
              </div>
            </div>
            <div class="flex items-center justify-between border-t pt-2">
              <span class="text-slate-700 font-semibold">Total</span>
              <span id="liveTotal" class="text-lg font-semibold">$0.00</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-slate-700">Amount Due</span>
              <span id="liveDue" class="font-semibold">$0.00</span>
            </div>
          </div>

          <div class="mt-6 flex items-center justify-end gap-3">
            <button id="refreshLive" class="rounded-2xl border px-4 py-2 text-sm hover:bg-slate-50">Refresh</button>
            <button id="closeTabBtn" class="rounded-2xl bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 text-sm">
              Close Out
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- RECOMMENDATIONS -->
  <main id="panel-rec" class="mx-auto max-w-7xl px-4 py-8 grid lg:grid-cols-12 gap-6 hidden">
    <section class="lg:col-span-8">
      <div class="flex items-start justify-between">
        <div>
          <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">Where everyone’s eating</h1>
          <p class="text-slate-600 mt-1">Top restaurants by transaction volume</p>
        </div>
        <button id="infoBtn" aria-label="About this chart"
                class="rounded-full border w-9 h-9 grid place-items-center text-slate-700 hover:bg-slate-50">?</button>
      </div>

      <div id="infoBox" class="hidden mt-3 rounded-2xl border bg-white p-4 text-sm shadow-sm">
        <p class="text-slate-700">
          <span class="font-semibold">How rankings work:</span>
          We aggregate anonymized transactions over the past 14 days. Bars show relative volume; tap a row to see details.
        </p>
      </div>

      <!-- Map + city search -->
      <div class="mt-6 rounded-3xl border border-slate-200 bg-white p-4 shadow-sm">
        <div class="flex items-center gap-3">
          <input id="citySearch"
                 placeholder="Search a city (e.g., San Francisco)"
                 class="flex-1 rounded-2xl border px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-slate-300"
                 type="text" autocomplete="off" />
          <button id="clearCity"
                  class="rounded-2xl border px-3 py-2 text-sm hover:bg-slate-50">
            Clear
          </button>
        </div>
        <div id="map" class="mt-4 rounded-2xl" style="height: 420px;"></div>
      </div>

      <div id="rankings" class="mt-6">
        <ul id="rankList" class="divide-y"></ul>
      </div>
    </section>

    <aside class="lg:col-span-4">
      <div class="rounded-3xl border border-slate-200 bg-white p-5 shadow-sm">
        <h2 class="text-lg font-semibold">Details</h2>
        <div id="detailsEmpty" class="mt-2 text-sm text-slate-600">
          Tap any bar on the left to see more info about a restaurant.
        </div>
        <div id="detailsBox" class="mt-4 space-y-2 hidden">
          <div class="text-sm"><span class="text-slate-500">Name:</span> <span id="dName" class="font-medium"></span></div>
          <div class="text-sm"><span class="text-slate-500">Address:</span> <span id="dAddr" class="font-medium"></span></div>
          <div class="text-sm"><span class="text-slate-500">Transactions:</span> <span id="dTx" class="font-medium"></span></div>
          <div class="text-sm"><span class="text-slate-500">Opened:</span> <span id="dOpened" class="font-medium"></span></div>
          <div class="pt-2">
            <a id="mapsLink" target="_blank" rel="noreferrer"
               class="inline-flex items-center gap-2 rounded-2xl border px-3 py-2 text-sm hover:bg-slate-50">Open in Maps</a>
          </div>
        </div>
      </div>
    </aside>
  </main>

  {% if user.is_authenticated %}
  <!-- TRANSACTIONS -->
  <main id="panel-txn" class="mx-auto max-w-7xl px-4 py-10 hidden">
    <div class="rounded-3xl border bg-white p-6">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <h2 class="text-2xl font-bold tracking-tight">Your Transactions</h2>
        <div id="txnCount" class="text-sm text-slate-600"></div>
      </div>
      <div class="mt-4 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-slate-500">
            <tr>
              <th class="py-3 pr-4">Date</th>
              <th class="py-3 pr-4">Restaurant</th>
              <th class="py-3 pr-4">City</th>
              <th class="py-3 pr-4 text-right">Subtotal</th>
              <th class="py-3 pr-4 text-right">Tip</th>
              <th class="py-3 pr-4 text-right">Total</th>
            </tr>
          </thead>
          <tbody id="txnBody" class="divide-y"></tbody>
        </table>
      </div>
    </div>
  </main>
  {% endif %}

  {% if user.is_authenticated %}
  <!-- PROFILE -->
  <main id="panel-profile" class="mx-auto max-w-3xl px-4 py-10 grid gap-6 hidden">
    <section class="rounded-3xl border bg-white p-6">
      <h2 class="text-xl font-semibold">Member Info</h2>
      <div class="mt-4 flex items-center justify-between">
        <div>
          <div class="text-sm text-slate-500">Member number</div>
          <div id="memberNum" class="text-2xl font-bold tracking-wider">
            {{ member_number|default:"—" }}
          </div>
        </div>
        <button id="copyBtn" class="rounded-2xl border px-4 py-2 text-sm hover:bg-slate-50">Copy</button>
      </div>
    </section>

    <section class="rounded-3xl border bg-white p-6">
      <h2 class="text-xl font-semibold">Card on file</h2>
      <div class="mt-4 flex items-center justify-between">
        <div>
          <div class="text-sm text-slate-500">Default payment method</div>
          <div id="cardLine" class="text-lg font-semibold">
            {% if card_brand and card_last4 %}
              {{ card_brand|title }} •••• {{ card_last4 }}
            {% else %}
              —
            {% endif %}
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button class="rounded-2xl border px-4 py-2 text-sm hover:bg-slate-50">Update</button>
          <button class="rounded-2xl border px-4 py-2 text-sm hover:bg-slate-50">Remove</button>
        </div>
      </div>
    </section>
  </main>
  {% endif %}

  <footer class="border-t border-slate-200">
    <div class="mx-auto max-w-7xl px-4 py-8 text-center text-sm text-slate-600">
      © <span id="year"></span> Dine N Dash
    </div>
  </footer>

  <script>
    // ------- Demo data for Rec/Txn -------
    const demoRestaurants = [
      { name: "Kumo Izakaya", tx: 106, address: "221 Market St, San Francisco, CA", opened: "2024-11-12" },
      { name: "Café Verona", tx: 101, address: "48 Clement Ave, San Francisco, CA", opened: "2023-04-04" },
      { name: "Spice Alley", tx: 96,  address: "431 Palm St, San Jose, CA", opened: "2024-08-18" },
      { name: "Tide & Tonic", tx: 93, address: "73 Beach Rd, Santa Cruz, CA", opened: "2025-07-12" },
      { name: "Morning Glory", tx: 90, address: "10 Sunrise Ave, Oakland, CA", opened: "2023-09-09" }
    ];
    const demoTxns = [
      { date: "2025-08-18", restaurant: "Kumo Izakaya", city: "San Francisco", subtotal: 64.2, tipPct: 18 },
      { date: "2025-08-12", restaurant: "Café Verona",  city: "San Francisco", subtotal: 49.9, tipPct: 20 }
    ];

    const member   = document.body.dataset.member || "";
    const hasLive  = document.body.dataset.live === "1";
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const money = c => `$${(Number(c||0)/100).toFixed(2)}`;

    // ----- Toast -----
    function showToast(msg, {title="Notice", tone="info"} = {}) {
      $("#toastTitle").textContent = title;
      $("#toastMsg").textContent = String(msg || "");
      const toneCls = tone === "error"
        ? "border-red-200 bg-red-50"
        : tone === "success"
          ? "border-emerald-200 bg-emerald-50"
          : "border-slate-200 bg-white";
      const iconCls = tone === "error" ? "bg-red-400" : tone === "success" ? "bg-emerald-400" : "bg-slate-400";
      $("#toastBox").className = `pointer-events-auto max-w-xl w-full rounded-2xl border px-4 py-3 shadow-lg ${toneCls} text-slate-800 flex items-start gap-3`;
      $("#toastIcon").className = `mt-[2px] h-5 w-5 rounded-full ${iconCls}`;
      $("#toast").classList.remove("hidden");
      $("#toastClose").onclick = () => $("#toast").classList.add("hidden");
      setTimeout(() => $("#toast").classList.add("hidden"), 4000);
    }

    // ----- Tabs (desktop & mobile) -----
    function getTabIds(){
      const tabs = new Set([...$$('[data-tab]')].map(b => b.dataset.tab));
      return Array.from(tabs);
    }
    function setTab(next){
      const ids = getTabIds();
      if (!ids.includes(next)) next = hasLive ? 'live' : 'rec';
      $$(".tab").forEach(b => {
        const active = b.dataset.tab === next;
        b.className = "tab px-4 py-2 rounded-2xl text-sm border " + (active ? "bg-slate-900 text-white border-slate-900" : "hover:bg-slate-50");
      });
      $$(".m-tab").forEach(b => {
        const active = b.dataset.tab === next;
        b.className = "m-tab w-full text-left px-4 py-3 rounded-xl text-base border " + (active ? "bg-slate-900 text-white border-slate-900" : "hover:bg-slate-50");
      });
      ids.forEach(id => {
        const panel = $("#panel-"+id);
        if (panel) panel.classList.toggle("hidden", id !== next);
      });
    }
    $$(".tab").forEach(b => b.addEventListener("click", () => setTab(b.dataset.tab)));
    $$(".m-tab").forEach(b => b.addEventListener("click", () => { setTab(b.dataset.tab); openDrawer(false); }));

    // ----- Mobile drawer -----
    function openDrawer(on) {
      const wrap = $("#drawerWrap"), drawer = $("#drawer"), backdrop = $("#drawerBackdrop");
      wrap.classList.toggle("pointer-events-none", !on);
      drawer.style.transform = on ? "translateX(0)" : "translateX(-100%)";
      backdrop.style.opacity = on ? "1" : "0";
    }
    $("#openMobile")?.addEventListener("click", () => openDrawer(true));
    $("#closeMobile")?.addEventListener("click", () => openDrawer(false));
    $("#drawerBackdrop")?.addEventListener("click", () => openDrawer(false));

    // ----- Recommendations (demo) -----
    function renderRec(){
      const ul = $("#rankList"); if (!ul) return;
      ul.innerHTML = "";
      const maxTx = demoRestaurants.reduce((m,r)=>Math.max(m, r.tx), 1);
      demoRestaurants.forEach((r,i) => {
        const pct = Math.round((r.tx / maxTx) * 100);
        const li = document.createElement("li");
        li.className = "py-3";
        li.innerHTML = `
          <button class="w-full text-left rounded-2xl p-3 border bg-white/70 hover:bg-white hover:shadow-sm transition"
                  data-idx="${i}">
            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-3 min-w-0">
                <div class="w-9 h-9 rounded-full grid place-items-center text-sm font-bold bg-slate-900 text-white">${i+1}</div>
                <div class="min-w-0">
                  <div class="font-semibold truncate">${r.name}</div>
                  <div class="text-xs text-slate-500 truncate">${r.address}</div>
                </div>
              </div>
              <div class="text-sm text-slate-600 whitespace-nowrap">${r.tx} tx</div>
            </div>
            <div class="mt-2 h-2 rounded-full bg-slate-100 overflow-hidden">
              <div class="h-full bg-slate-900/80" style="width:${pct}%"></div>
            </div>
          </button>`;
        ul.appendChild(li);
      });

      ul.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-idx]");
        if (!btn) return;
        const i = +btn.dataset.idx;
        const r = demoRestaurants[i];
        $("#detailsEmpty")?.classList.add("hidden");
        $("#detailsBox")?.classList.remove("hidden");
        $("#dName").textContent = r.name;
        $("#dAddr").textContent = r.address;
        $("#dTx").textContent = r.tx;
        $("#dOpened").textContent = r.opened;
        $("#mapsLink").href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.address)}`;
      });
    }

    // ----- Transactions (demo) -----
    function renderTxn(){
      const body = $("#txnBody"); const count = $("#txnCount");
      if (!body || !count) return;
      body.innerHTML = "";
      demoTxns.forEach(t => {
        const tip = +(t.subtotal * (t.tipPct / 100)).toFixed(2);
        const total = +(t.subtotal + tip).toFixed(2);
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-50";
        tr.innerHTML = `
          <td class="py-3 pr-4">${t.date}</td>
          <td class="py-3 pr-4">${t.restaurant}</td>
          <td class="py-3 pr-4">${t.city}</td>
          <td class="py-3 pr-4 text-right">$${t.subtotal.toFixed(2)}</td>
          <td class="py-3 pr-4 text-right">${t.tipPct}% ($${tip.toFixed(2)})</td>
          <td class="py-3 pr-4 text-right font-semibold">$${total.toFixed(2)}</td>`;
        body.appendChild(tr);
      });
      count.textContent = `${demoTxns.length} total`;
    }

    // ===== Flicker-free Live Order (SWR) =====
    const POLL_MS_BASE = 8000;
    let firstPaint = true;
    let lastFP = null;
    let timer = null;
    let ctrl  = null;

    function fingerprint(d){
      const key = JSON.stringify({
        i: (d.items||[]).map(i => [i.name, i.qty, i.cents]),
        s: d.subtotal_cents, t: d.tax_cents, T: d.total_cents, d: d.due_cents
      });
      let h=0; for (let i=0;i<key.length;i++) { h = (h*31 + key.charCodeAt(i))|0; }
      return String(h);
    }

    function renderLive(d){
      $("#liveServer").textContent   = d.server || "";
      $("#liveSubtotal").textContent = money(d.subtotal_cents);
      $("#liveTax").textContent      = money(d.tax_cents);

      const pctEl = $("#tipPct");
      const pct   = pctEl ? Math.max(0, parseFloat(pctEl.value || "0")) : 0;
      const tip   = Math.round((d.subtotal_cents||0) * (pct/100));
      $("#liveTipAmt").textContent = money(tip);
      $("#liveTotal").textContent  = money((d.total_cents||0) + tip);
      $("#liveDue").textContent    = money((d.due_cents||0) + tip);

      const ul = $("#liveItems");
      ul.innerHTML = (d.items||[]).map(i => `
        <li class="flex items-center justify-between py-2">
          <span class="truncate">${i.name || ""}</span>
          <span class="tabular-nums text-slate-700">${i.qty} × ${money(i.cents)}</span>
        </li>
      `).join("");
    }

    function showLiveBlocks(state){
      const loading = $("#liveLoading");
      const content = $("#liveContent");
      const empty   = $("#liveEmpty");
      if (state === "loading-first") {
        loading?.classList.remove("hidden");
        content?.classList.add("hidden");
        empty?.classList.add("hidden");
      } else if (state === "show-content") {
        loading?.classList.add("hidden");
        empty?.classList.add("hidden");
        content?.classList.remove("hidden");
      } else if (state === "empty") {
        loading?.classList.add("hidden");
        content?.classList.add("hidden");
        empty?.classList.remove("hidden");
      }
    }

    async function fetchReceipt({silent=false} = {}){
      if (!member) return;
      if (ctrl) ctrl.abort();
      ctrl = new AbortController();
      if (firstPaint && !silent) showLiveBlocks("loading-first");

      try {
        const r = await fetch(`/api/member/${encodeURIComponent(member)}/receipt`, {
          signal: ctrl.signal, cache: "no-store", headers: {"Accept":"application/json"}
        });
        if (r.status === 404) {
          showLiveBlocks("empty");
          scheduleNext(POLL_MS_BASE);
          return;
        }
        const d = await r.json();
        if (!r.ok || !d.ok) throw new Error(d.error || `HTTP ${r.status}`);

        if (firstPaint) showLiveBlocks("show-content");

        const fp = fingerprint(d);
        if (fp !== lastFP) {
          lastFP = fp;
          renderLive(d);
        }
        firstPaint = false;
        scheduleNext(POLL_MS_BASE);
      } catch (err) {
        if (err.name === "AbortError") return;
        scheduleNext(Math.min(POLL_MS_BASE * 2, 30000));
      }
    }

    function scheduleNext(ms){
      clearTimeout(timer);
      timer = setTimeout(() => fetchReceipt({silent:true}), ms);
    }

    document.addEventListener("visibilitychange", () => {
      if (document.hidden) {
        clearTimeout(timer);
        if (ctrl) ctrl.abort();
      } else {
        fetchReceipt({silent:true});
      }
    });

    // Tip preview
    $("#tipPct")?.addEventListener("input", () => {
      const sub = ($("#liveSubtotal")?.textContent || "$0").replace(/[^0-9.]/g,"");
      const tax = ($("#liveTax")?.textContent || "$0").replace(/[^0-9.]/g,"");
      const pct = Math.max(0, parseFloat($("#tipPct").value || "0"));
      const subCents = Math.round(parseFloat(sub || "0") * 100);
      const taxCents = Math.round(parseFloat(tax || "0") * 100);
      const tip = Math.round(subCents * (pct/100));
      $("#liveTipAmt").textContent = money(tip);
      $("#liveTotal").textContent  = money(subCents + taxCents + tip);
      $("#liveDue").textContent    = money((subCents + taxCents) + tip); // UI-only preview
    });

    // Manual refresh
    $("#refreshLive")?.addEventListener("click", () => fetchReceipt({silent:true}));

    // Close out
    function getCSRFCookie(){ const m = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/); return m ? decodeURIComponent(m[1]) : ""; }
    $("#closeTabBtn")?.addEventListener("click", async () => {
      try {
        const r = await fetch(`/api/member/${encodeURIComponent(member)}/close`, {
          method:"POST",
          headers: {"X-CSRFToken": getCSRFCookie()},
          body: "{}"
        });
        if (r.ok) {
          showToast("Closed out & receipt updated.", {tone:"success"});
          firstPaint = true; lastFP = null;
          await fetchReceipt({silent:false});
        } else {
          showToast("Close out failed.", {tone:"error"});
        }
      } catch {
        showToast("Network error while closing.", {tone:"error"});
      }
    });

    // Info box
    let openInfo = false;
    $("#infoBtn")?.addEventListener("click", () => {
      openInfo = !openInfo;
      $("#infoBox")?.classList.toggle("hidden", !openInfo);
    });

    // Copy member number
    $("#copyBtn")?.addEventListener("click", async () => {
      try { await navigator.clipboard.writeText(member || ""); showToast("Copied!", {tone:"success"}); } catch {}
    });

    // Init
    document.addEventListener("DOMContentLoaded", () => {
      const y = $("#year"); if (y) y.textContent = new Date().getFullYear();

      // default tab
      setTab(hasLive ? "live" : "rec");

      // render static panels
      renderRec();
      renderTxn();

      // start polling only if live
      if (hasLive) fetchReceipt({silent:false});
    });



    /* ========== GOOGLE MAPS: Restaurants + City Filter ========== */
    let gmap, gmarkers = [], ginfo, geocoder, allRestaurants = [];
    let cityAutocomplete;

    async function fetchRestaurants(){
      // TODO: swap to backend when ready:
      // const r = await fetch('/api/restaurants/map', {headers:{Accept:'application/json'}});
      // const d = await r.json(); return d.items; // [{id,name,address,city,lat,lng,tx}]
      return demoRestaurants.map((r, idx) => ({
        id: idx+1,
        name: r.name,
        address: r.address,
        city: (r.address.split(",")[1] || "").trim(),
        lat: null, lng: null,
        tx: r.tx
      }));
    }

    function cacheKey(addr){ return `geo:${addr}`; }

    async function geocodeOnce(addr){
      const key = cacheKey(addr);
      const cached = sessionStorage.getItem(key);
      if (cached) return JSON.parse(cached);
      return new Promise((resolve) => {
        geocoder.geocode({ address: addr }, (results, status) => {
          if (status === "OK" && results[0]) {
            const loc = results[0].geometry.location;
            const pt = { lat: loc.lat(), lng: loc.lng() };
            sessionStorage.setItem(key, JSON.stringify(pt));
            resolve(pt);
          } else {
            resolve(null);
          }
        });
      });
    }

    function markerIcon(){
      return {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 6,
        fillColor: '#0f172a',
        fillOpacity: 0.95,
        strokeColor: '#0f172a',
        strokeWeight: 1
      };
    }

    function clearMarkers(){ gmarkers.forEach(m => m.setMap(null)); gmarkers = []; }

    function addMarker(r){
      const m = new google.maps.Marker({
        position: {lat:r.lat, lng:r.lng},
        map: gmap,
        title: r.name,
        icon: markerIcon()
      });
      m.__data = r;
      m.addListener('click', () => {
        const html = `
          <div style="min-width:220px">
            <div style="font-weight:600">${r.name}</div>
            <div style="color:#64748b; font-size:12px">${r.address}</div>
            <div style="margin-top:6px; font-size:12px">Transactions: <b>${r.tx ?? '-'}</b></div>
            <div style="margin-top:8px">
              <a target="_blank" rel="noreferrer"
                 href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.address)}"
                 style="text-decoration:underline">Open in Google Maps</a>
            </div>
          </div>`;
        ginfo.setContent(html);
        ginfo.open(gmap, m);

        // Sync details panel
        $("#detailsEmpty")?.classList.add("hidden");
        $("#detailsBox")?.classList.remove("hidden");
        $("#dName").textContent = r.name;
        $("#dAddr").textContent = r.address;
        $("#dTx").textContent = r.tx ?? "-";
        $("#dOpened").textContent = "";
        $("#mapsLink").href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.address)}`;
      });
      gmarkers.push(m);
    }

    function fitToMarkers(markers){
      if (!markers.length) return;
      const bounds = new google.maps.LatLngBounds();
      markers.forEach(m => bounds.extend(m.getPosition()));
      gmap.fitBounds(bounds, { top: 50, bottom: 50, left: 50, right: 50 });
    }

    function filterListByCity(city){
      const ul = $("#rankList");
      if (!ul) return;
      const normalized = (city || "").toLowerCase();
      const rows = Array.from(ul.querySelectorAll("li"));
      rows.forEach(li => {
        const addr = li.querySelector(".text-xs")?.textContent || "";
        const thisCity = (addr.split(",")[1] || "").trim().toLowerCase();
        li.classList.toggle("hidden", normalized && thisCity !== normalized);
      });
    }

    function filterMarkersByCity(city){
      const normalized = (city || "").toLowerCase();
      const visible = [];
      gmarkers.forEach(m => {
        const c = (m.__data.city || "").toLowerCase();
        const show = !normalized || c === normalized;
        m.setVisible(show);
        if (show) visible.push(m);
      });
      if (visible.length) fitToMarkers(visible);
    }

    async function buildMarkers(items){
      const withGeo = await Promise.all(items.map(async r => {
        if (r.lat && r.lng) return r;
        const pt = await geocodeOnce(r.address);
        if (pt) { r.lat = pt.lat; r.lng = pt.lng; }
        return r;
      }));
      allRestaurants = withGeo.filter(r => r.lat && r.lng);

      clearMarkers();
      allRestaurants.forEach(addMarker);
      fitToMarkers(gmarkers);
    }

    function setupPlacesAutocomplete(){
      const input = $("#citySearch");
      cityAutocomplete = new google.maps.places.Autocomplete(input, {
        types: ["(cities)"],
      });
      cityAutocomplete.addListener("place_changed", () => {
        const place = cityAutocomplete.getPlace();
        let city = "";
        if (place && place.address_components) {
          const comp = place.address_components.find(c => c.types.includes("locality")) ||
                       place.address_components.find(c => c.types.includes("postal_town")) ||
                       place.address_components.find(c => c.types.includes("administrative_area_level_3"));
          city = comp ? comp.long_name : (place.name || "");
        } else {
          city = input.value.trim();
        }
        if (place && place.geometry) {
          if (place.geometry.viewport) gmap.fitBounds(place.geometry.viewport);
          else if (place.geometry.location) gmap.setCenter(place.geometry.location);
        }
        filterMarkersByCity(city);
        filterListByCity(city);
      });

      $("#clearCity")?.addEventListener("click", () => {
        $("#citySearch").value = "";
        filterMarkersByCity("");
        filterListByCity("");
        fitToMarkers(gmarkers);
      });
    }

    // Expose init for Google loader
    window.initDndMap = async function initDndMap(){
      geocoder = new google.maps.Geocoder();
      ginfo = new google.maps.InfoWindow();

      // Initial center: SF as a neutral start
      gmap = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 37.773972, lng: -122.431297 },
        zoom: 6,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true,
      });

      setupPlacesAutocomplete();

      const items = await fetchRestaurants();
      await buildMarkers(items);
    };
  </script>

  <!-- Google Maps loader (enable Maps JavaScript API + Places API & restrict the key) -->
<script async
  src="https://maps.googleapis.com/maps/api/js?key={{ maps_api_key }}&libraries=places&callback=initDndMap">
</script>

</body>
</html>
