{% load static socialaccount %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Customer Sign Up â€” Dyne</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="csrf-token" content="{{ csrf_token }}">
</head>
<body class="bg-gradient-to-b from-white to-slate-50 text-slate-900 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="border-b border-slate-200 bg-white/80 backdrop-blur">
    <div class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-2xl bg-slate-900 text-white grid place-items-center font-semibold">D</div>
      </a>
      <a href="/restaurant/signin" class="rounded-2xl bg-slate-900 text-white px-4 py-2 text-sm">Restaurant Sign In</a>
    </div>
  </header>

  <main class="flex-1 grid place-items-center px-6">
    <section class="w-full max-w-md">
      <div class="rounded-3xl border border-slate-200 bg-white shadow-sm p-8">
        <div id="alert" class="hidden mb-4 text-sm px-4 py-3 rounded-md"></div>

        <h1 class="text-2xl font-bold text-center">Customer Sign Up</h1>
        <p class="mt-1 text-center text-sm text-slate-600">Start with your email.</p>

        <!-- Step 0: email only -->
        <form id="emailForm" class="space-y-4 mt-6">
          {% csrf_token %}
          <div>
            <label class="block text-sm font-medium mb-1">Email</label>
            <input id="email" type="email" class="w-full h-12 rounded-2xl border px-4" placeholder="you@example.com" required>
          </div>
          <button class="w-full h-12 rounded-2xl bg-slate-900 text-white">Continue</button>
        </form>

        <!-- Step 1a: details for NEW users -->
        <form id="newUserForm" class="space-y-4 mt-6 hidden">
          {% csrf_token %}
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">First name</label>
              <input id="first_name" class="w-full h-12 rounded-2xl border px-4" autocomplete="given-name">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Last name</label>
              <input id="last_name" class="w-full h-12 rounded-2xl border px-4" autocomplete="family-name">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Phone</label>
            <input id="phone_new" type="tel" inputmode="tel" class="w-full h-12 rounded-2xl border px-4" placeholder="+15551234567">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">Password</label>
              <input id="password1" type="password" class="w-full h-12 rounded-2xl border px-4">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Confirm</label>
              <input id="password2" type="password" class="w-full h-12 rounded-2xl border px-4">
            </div>
          </div>
          <button id="newUserNext" class="w-full h-12 rounded-2xl bg-slate-900 text-white">Continue</button>
        </form>

        <!-- Step 1b: minimal for EXISTING users -->
        <form id="existingUserForm" class="space-y-4 mt-6 hidden">
          {% csrf_token %}
          <p class="text-sm text-slate-600">We found your account. Weâ€™ll verify itâ€™s you via SMS.</p>
          <div id="existing_phone_block" class="hidden">
            <label class="block text-sm font-medium mb-1">Weâ€™ll text your verified phone</label>
            <input id="phone_existing_display" class="w-full h-12 rounded-2xl border px-4 bg-slate-50" readonly>
          </div>
          <div id="collect_phone_block">
            <label class="block text-sm font-medium mb-1">Phone</label>
            <input id="phone_existing" type="tel" inputmode="tel" class="w-full h-12 rounded-2xl border px-4" placeholder="+15551234567">
          </div>
          <button id="existingUserNext" class="w-full h-12 rounded-2xl bg-slate-900 text-white">Send Code</button>
        </form>

        <!-- Step 2: PHONE OTP (both paths) -->
        <form id="phoneOtpForm" class="space-y-4 mt-6 hidden">
          {% csrf_token %}
          <p class="text-sm text-slate-600">Enter the 6-digit SMS code.</p>
          <input id="otpCode" maxlength="6" inputmode="numeric" class="w-full h-12 rounded-2xl border px-4" placeholder="123456">
          <button class="w-full h-12 rounded-2xl bg-slate-900 text-white">Verify phone</button>
        </form>

        <!-- Step 3: EMAIL OTP (new users only) -->
        <form id="emailOtpForm" class="space-y-4 mt-6 hidden">
          {% csrf_token %}
          <p class="text-sm text-slate-600">Enter the 6-digit email code we sent to <span id="otpEmail" class="font-medium"></span>.</p>
          <input id="emailCode" maxlength="6" inputmode="numeric" class="w-full h-12 rounded-2xl border px-4" placeholder="123456">
          <button class="w-full h-12 rounded-2xl bg-slate-900 text-white">Verify email</button>
        </form>

        <div class="my-6 flex items-center gap-3">
          <div class="h-px flex-1 bg-slate-200"></div>
          <span class="text-xs uppercase tracking-wide text-slate-500">or</span>
          <div class="h-px flex-1 bg-slate-200"></div>
        </div>

<!-- Google Sign In -->
<div class="mt-4">
  <a href="{% url 'core:customer_google_start' %}"
     class="w-full h-12 rounded-2xl border border-slate-300 bg-white hover:bg-slate-50 flex items-center justify-center gap-3 transition">
    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"
         class="h-5 w-5" alt="Google">
    <span class="font-medium">Continue with Google</span>
  </a>
</div>

      </div>
    </section>
  </main>

  <footer class="mt-10 border-t border-slate-200">
    <div class="mx-auto max-w-7xl px-4 py-8 text-center text-sm text-slate-600">
      <p>&copy; <script>document.write(new Date().getFullYear())</script> Dyne</p>
    </div>
  </footer>

<script>
  function csrf(){
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : '';
  }

  function alertBox(msg, ok=false){
    const el = document.getElementById('alert');
    el.className = 'mb-4 text-sm px-4 py-3 rounded-md ' + (ok
      ? 'bg-green-100 text-green-800'
      : 'bg-red-100 text-red-800');
    el.textContent = msg;
    el.classList.remove('hidden');
  }

  const emailForm          = document.getElementById('emailForm');
  const newUserForm        = document.getElementById('newUserForm');
  const existingUserForm   = document.getElementById('existingUserForm');
  const existingPhoneBlock = document.getElementById('existing_phone_block');
  const collectPhoneBlock  = document.getElementById('collect_phone_block');
  const phoneOtpForm       = document.getElementById('phoneOtpForm');
  const emailOtpForm       = document.getElementById('emailOtpForm');

  let pre = { exists:false, has_verified_phone:false, email:"" };

  // Step 0: precheck
  emailForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email = document.getElementById('email').value.trim().toLowerCase();
    if(!email) return alertBox('Enter your email.');

    const r = await fetch("{% url 'core:customer_precheck_api' %}", {
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken': csrf()},
      body: JSON.stringify({ email })
    });

    const d = await r.json();

    // If backend says "this email should sign in instead"
    if (r.status === 409 && d.redirect) {
      window.location.href = d.redirect;
      return;
    }

    if (!r.ok || !d.ok) {
      return alertBox(d.error || 'Precheck failed.');
    }

    pre = { exists: d.exists, has_verified_phone: d.has_verified_phone, email };
    emailForm.classList.add('hidden');

    if (d.exists) {
      // Existing account flow
      existingUserForm.classList.remove('hidden');
      if (d.has_verified_phone) {
        existingPhoneBlock.classList.remove('hidden');
        collectPhoneBlock.classList.add('hidden');
        document.getElementById('phone_existing_display').value = 'Verified phone on file';
      } else {
        existingPhoneBlock.classList.add('hidden');
        collectPhoneBlock.classList.remove('hidden');
      }
    } else {
      // New account flow
      newUserForm.classList.remove('hidden');
    }
  });

  // Existing -> begin
  document.getElementById('existingUserNext').addEventListener('click', async (e)=>{
    e.preventDefault();
    const payload = { email: pre.email };

    if (!pre.has_verified_phone) {
      const p = document.getElementById('phone_existing').value.trim();
      if (!p) return alertBox('Enter your phone.');
      payload.phone = p;
    }

    const r = await fetch("{% url 'core:customer_begin_api' %}", {
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken': csrf()},
      body: JSON.stringify(payload)
    });

    const d = await r.json();

    if (!r.ok || !d.ok) {
      return alertBox(d.error || 'Could not send SMS.');
    }

    existingUserForm.classList.add('hidden');
    phoneOtpForm.classList.remove('hidden');
    alertBox('Code sent. Check your phone.', true);
  });

  // New -> begin
  document.getElementById('newUserNext').addEventListener('click', async (e)=>{
    e.preventDefault();

    const payload = {
      email:      document.getElementById('email').value.trim().toLowerCase(),
      first_name: document.getElementById('first_name').value.trim(),
      last_name:  document.getElementById('last_name').value.trim(),
      phone:      document.getElementById('phone_new').value.trim(),
      password1:  document.getElementById('password1').value,
      password2:  document.getElementById('password2').value
    };

    if (!payload.first_name || !payload.last_name || !payload.phone || !payload.password1 || !payload.password2){
      return alertBox('Please fill all fields.');
    }

    const r = await fetch("{% url 'core:customer_begin_api' %}", {
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken': csrf()},
      body: JSON.stringify(payload)
    });

    const d = await r.json();

    // ðŸ”¹ Phone already registered â†’ backend returns 409 + signin_url
    if (r.status === 409 && d.signin_url) {
      alertBox(d.error || 'That phone number is already registered. Redirecting to sign in...');
      setTimeout(() => {
        window.location.href = d.signin_url;
      }, 1500); // tiny pause so user sees the message
      return;
    }

    if (!r.ok || !d.ok) {
      return alertBox(d.error || 'Could not start signup.');
    }

    newUserForm.classList.add('hidden');
    phoneOtpForm.classList.remove('hidden');
    alertBox('Code sent. Check your phone.', true);
  });

  // Phone OTP -> verify_otp
  phoneOtpForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const code = document.getElementById('otpCode').value.trim();
    if (!/^\d{6}$/.test(code)) return alertBox('Enter the 6-digit code.');

    const r = await fetch("{% url 'core:verify_otp' %}", {
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken': csrf()},
      body: JSON.stringify({ code })
    });

    const d = await r.json();

    if (!r.ok || !d.ok) {
      return alertBox(d.error || 'Invalid or expired code.');
    }

    if (d.stage === 'email') { // NEW users continue with email
      document.getElementById('otpEmail').textContent = d.email || pre.email;
      phoneOtpForm.classList.add('hidden');
      emailOtpForm.classList.remove('hidden');
      alertBox(d.message || 'Phone verified. Check your email for a code.', true);
    } else if (d.redirect) { // EXISTING users are done
      location.href = d.redirect;
    } else {
      alertBox('Unexpected response.');
    }
  });

  // Email OTP (new only)
  emailOtpForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const code = document.getElementById('emailCode').value.trim();
    if (!/^\d{6}$/.test(code)) return alertBox('Enter the 6-digit code.');

    const r = await fetch("{% url 'core:verify_email_otp' %}", {
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken': csrf()},
      body: JSON.stringify({ code })
    });

    const d = await r.json();

    if (!r.ok || !d.ok) {
      return alertBox(d.error || 'Invalid code.');
    }

    location.href = d.redirect || '/profile';
  });
</script>

</body>
</html>

