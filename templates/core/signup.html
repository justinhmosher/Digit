{% load static socialaccount %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta property="og:title" content="DYNE">
  <meta property="og:description" content="The Country Club Experience">
  <meta property="og:image" content="https://dynepay.io{% static 'Logo.png' %}">
  <meta property="og:url" content="https://dynepay.io/signup">
  <meta property="og:type" content="website">

<!-- Helps Twitter/X too -->
<meta name="twitter:card" content="summary_large_image">
  <title>Customer Sign Up — Dyne</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="csrf-token" content="{{ csrf_token }}">
</head>
<body class="bg-gradient-to-b from-white to-slate-50 text-slate-900 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="border-b border-slate-200 bg-white/80 backdrop-blur">
    <div class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-2xl bg-slate-900 text-white grid place-items-center font-semibold">D</div>
      </a>
      <a href="/restaurant/signin" class="rounded-2xl bg-slate-900 text-white px-4 py-2 text-sm">Restaurant Sign In</a>
    </div>
  </header>

  <main class="flex-1 grid place-items-center px-6">
    <section class="w-full max-w-md">
      <div class="rounded-3xl border border-slate-200 bg-white shadow-sm p-8">
        <div id="alert" class="hidden mb-4 text-sm px-4 py-3 rounded-md"></div>

        <h1 class="text-2xl font-bold text-center">Customer Sign Up</h1>
        <p class="mt-1 text-center text-sm text-slate-600">Create your Dyne account.</p>

        <!-- Single full sign-up form -->
        <form id="newUserForm" class="space-y-4 mt-6">
          {% csrf_token %}

          <div>
            <label class="block text-sm font-medium mb-1">Email</label>
            <input id="email"
                   type="email"
                   class="w-full h-12 rounded-2xl border px-4"
                   placeholder="you@example.com"
                   autocomplete="email"
                   required>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">First name</label>
              <input id="first_name"
                     class="w-full h-12 rounded-2xl border px-4"
                     autocomplete="given-name"
                     required>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Last name</label>
              <input id="last_name"
                     class="w-full h-12 rounded-2xl border px-4"
                     autocomplete="family-name"
                     required>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Phone</label>
            <input id="phone_new"
                   type="tel"
                   inputmode="tel"
                   class="w-full h-12 rounded-2xl border px-4"
                   placeholder="+1 (555) 123-4567"
                   required>
          </div>

          <!-- SMS opt-in block -->
          <div class="space-y-1 text-xs text-slate-600">
            <div class="flex items-start gap-2">
              <input id="sms_opt_in"
                     type="checkbox"
                     class="mt-0.5 h-4 w-4 rounded border-slate-300"
                     required>
              <label for="sms_opt_in" class="leading-snug">
                I agree to receive SMS messages from Dyne for account authentication
                and to view my live receipt while dining. No marketing messages will be sent.
                Message and data rates may apply.
                Opt-in is required to create an account.
              </label>
            </div>
            <button
              type="button"
              id="smsDisclosureBtn"
              class="text-xs underline text-blue-600 hover:text-blue-700">
              Read the full disclosure
            </button>
          </div>

          <div class="grid grid-cols-2 gap-3 pt-2">
            <div>
              <label class="block text-sm font-medium mb-1">Password</label>
              <input id="password1"
                     type="password"
                     class="w-full h-12 rounded-2xl border px-4"
                     required>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Confirm</label>
              <input id="password2"
                     type="password"
                     class="w-full h-12 rounded-2xl border px-4"
                     required>
            </div>
          </div>
                                <!-- New required agreements -->
          <div class="space-y-2 pt-2 text-xs text-slate-600">
            <div class="flex items-start gap-2">
              <input id="agree_terms"
                     name="agree_terms"
                     type="checkbox"
                     class="mt-0.5 h-4 w-4 rounded border-slate-300"
                     required>
              <label for="agree_terms" class="leading-snug">
                I have read and agree to the
                <a href="/terms" class="text-blue-600 underline hover:text-blue-700">
                  Terms and Conditions
                </a> and <a href="/privacy" class="text-blue-600 underline hover:text-blue-700">
                  Privacy Policy
                </a>.
              </label>
            </div>
          </div>

          <button id="newUserNext"
                  class="w-full h-12 rounded-2xl bg-slate-900 text-white mt-2">
            Continue
          </button>
        </form>

        <!-- Step 2: PHONE OTP -->
        <form id="phoneOtpForm" class="space-y-4 mt-6 hidden">
          {% csrf_token %}
          <p class="text-sm text-slate-600">Enter the 6-digit SMS code.</p>
          <input id="otpCode"
                 maxlength="6"
                 inputmode="numeric"
                 class="w-full h-12 rounded-2xl border px-4"
                 placeholder="123456">
          <button class="w-full h-12 rounded-2xl bg-slate-900 text-white">
            Verify phone
          </button>
        </form>

        <!-- Step 3: EMAIL OTP -->
        <form id="emailOtpForm" class="space-y-4 mt-6 hidden">
          {% csrf_token %}
          <p class="text-sm text-slate-600">
            Enter the 6-digit email code we sent to
            <span id="otpEmail" class="font-medium"></span>.
          </p>
          <input id="emailCode"
                 maxlength="6"
                 inputmode="numeric"
                 class="w-full h-12 rounded-2xl border px-4"
                 placeholder="123456">
          <button class="w-full h-12 rounded-2xl bg-slate-900 text-white">
            Verify email
          </button>
        </form>

        <div class="my-6 flex items-center gap-3">
          <div class="h-px flex-1 bg-slate-200"></div>
          <span class="text-xs uppercase tracking-wide text-slate-500">or</span>
          <div class="h-px flex-1 bg-slate-200"></div>
        </div>

        <!-- Google Sign In -->
        <div class="mt-4">
          <a href="{% url 'core:customer_google_start' %}"
             class="w-full h-12 rounded-2xl border border-slate-300 bg-white hover:bg-slate-50 flex items-center justify-center gap-3 transition">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"
                 class="h-5 w-5" alt="Google">
            <span class="font-medium">Continue with Google</span>
          </a>
        </div>

      </div>
    </section>
  </main>

  <footer class="mt-10 border-t border-slate-200">
    <div class="mx-auto max-w-7xl px-4 py-8 text-center text-sm text-slate-600">
      <p><a href="/terms" class="hover:underline">Terms and Conditions</a> ·
         <a href="/privacy" class="hover:underline">Privacy Policy</a> ·
         <a href="mailto:commissioner@thechosenfg.com" class="hover:underline">Contact Us</a></p>
      <p class="mt-2">&copy; <script>document.write(new Date().getFullYear())</script> Dyne</p>
    </div>
  </footer>

  <!-- SMS Disclosure Modal -->
  <div id="smsDisclosureModal"
       class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
    <div class="mx-4 max-w-lg rounded-2xl bg-white p-6 shadow-xl relative">
      <button type="button"
              id="smsDisclosureClose"
              class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-sm">
        ✕
      </button>
      <h2 class="text-lg font-semibold mb-3">SMS Disclosure</h2>
      <div class="space-y-3 text-sm text-slate-700 max-h-72 overflow-y-auto pr-1">
        <p>
          By providing your mobile phone number and checking the box on the sign-up form,
          you agree to receive SMS text messages from Dyne for the limited purposes of:
        </p>
        <ul class="list-disc list-inside space-y-1">
          <li>Authenticating your account and logging you in securely</li>
          <li>Sending links to view your live receipt while dining</li>
        </ul>
        <p>
          Dyne will not use your phone number to send marketing or promotional messages.
        </p>
        <p>
          Message and data rates may apply from your mobile carrier. Message frequency
          will vary depending on your usage (for example, when you sign in or view a
          live receipt at participating restaurants).
        </p>
        <p>
          For help, reply <strong>HELP</strong> or contact us at
          <a href="mailto:info@dynepay.io" class="text-blue-600 underline">info@dynepay.io</a>.
        </p>
        <p>
          For more information about how we handle your data, please review our
          <a href="/privacy" class="text-blue-600 underline">Privacy Policy</a>.
        </p>
      </div>
      <div class="mt-4 flex justify-end">
        <button type="button"
                id="smsDisclosureOk"
                class="rounded-2xl bg-slate-900 text-white px-4 py-2 text-sm">
          Close
        </button>
      </div>
    </div>
  </div>

<script>
  function csrf() {
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : '';
  }

  function alertBox(msg, ok = false) {
    const el = document.getElementById('alert');
    el.className =
      'mb-4 text-sm px-4 py-3 rounded-md ' +
      (ok ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800');
    el.textContent = msg;
    el.classList.remove('hidden');
  }

  const newUserForm   = document.getElementById('newUserForm');
  const phoneOtpForm  = document.getElementById('phoneOtpForm');
  const emailOtpForm  = document.getElementById('emailOtpForm');

  const smsOptIn      = document.getElementById('sms_opt_in');
  const agreeTerms    = document.getElementById('agree_terms');

  const smsDisclosureBtn    = document.getElementById('smsDisclosureBtn');
  const smsDisclosureModal  = document.getElementById('smsDisclosureModal');
  const smsDisclosureClose  = document.getElementById('smsDisclosureClose');
  const smsDisclosureOk     = document.getElementById('smsDisclosureOk');

  function openSmsModal() {
    smsDisclosureModal.classList.remove('hidden');
    smsDisclosureModal.classList.add('flex');
  }

  function closeSmsModal() {
    smsDisclosureModal.classList.add('hidden');
    smsDisclosureModal.classList.remove('flex');
  }

  smsDisclosureBtn.addEventListener('click', openSmsModal);
  smsDisclosureClose.addEventListener('click', closeSmsModal);
  smsDisclosureOk.addEventListener('click', closeSmsModal);

  smsDisclosureModal.addEventListener('click', (e) => {
    if (e.target === smsDisclosureModal) {
      closeSmsModal();
    }
  });

  // Submit full signup form → hits customer_begin_api (NOT signup)
  document.getElementById('newUserNext').addEventListener('click', async (e) => {
    e.preventDefault();

    const payload = {
      email:      document.getElementById('email').value.trim().toLowerCase(),
      first_name: document.getElementById('first_name').value.trim(),
      last_name:  document.getElementById('last_name').value.trim(),
      phone:      document.getElementById('phone_new').value.trim(),
      password1:  document.getElementById('password1').value,
      password2:  document.getElementById('password2').value,
      sms_opt_in: smsOptIn.checked ? true : false,
      agree_terms: agreeTerms.checked ? true : false,
    };

    if (
      !payload.email ||
      !payload.first_name ||
      !payload.last_name ||
      !payload.phone ||
      !payload.password1 ||
      !payload.password2
    ) {
      return alertBox('Please fill all fields.');
    }

    if (!smsOptIn.checked) {
      return alertBox('You must agree to SMS authentication messages to create an account.');
    }

    if (!agreeTerms.checked) {
      return alertBox('You must agree to the Terms and Conditions and Privacy Policy to create an account.');
    }

    let r, d;
    try {
      r = await fetch("{% url 'core:customer_begin_api' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrf(),
        },
        body: JSON.stringify(payload),
      });
      d = await r.json();
    } catch (err) {
      console.error(err);
      return alertBox('Network error. Please try again.');
    }

    // Existing account → redirect to sign-in (if backend returns that)
    if (r.status === 409 && d.signin_url) {
      alertBox(d.error || 'Account already exists. Redirecting to sign in...');
      setTimeout(() => {
        window.location.href = d.signin_url;
      }, 1500);
      return;
    }

    if (!r.ok || !d.ok) {
      return alertBox(d.error || 'Could not start signup.');
    }

    // At this point, customer_begin_api has sent the SMS and stashed the session bundle.
    newUserForm.classList.add('hidden');
    phoneOtpForm.classList.remove('hidden');
    alertBox(d.message || 'Code sent. Check your phone.', true);
  });

  // Phone OTP submit
  phoneOtpForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const code = document.getElementById('otpCode').value.trim();
    if (!/^\d{6}$/.test(code)) {
      return alertBox('Enter the 6-digit code.');
    }

    let r, d;
    try {
      r = await fetch("{% url 'core:verify_otp' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrf(),
        },
        body: JSON.stringify({ code }),
      });
      d = await r.json();
    } catch (err) {
      console.error(err);
      return alertBox('Network error. Please try again.');
    }

    if (!r.ok || !d.ok) {
      return alertBox(d.error || 'Invalid or expired code.');
    }

    if (d.stage === 'email') {
      const emailFromBackend = d.email;
      const emailFromForm = document.getElementById('email').value.trim().toLowerCase();
      document.getElementById('otpEmail').textContent = emailFromBackend || emailFromForm;

      phoneOtpForm.classList.add('hidden');
      emailOtpForm.classList.remove('hidden');
      alertBox(d.message || 'Phone verified. Check your email for a code.', true);
    } else if (d.redirect) {
      // Existing-user path may go straight to add-card
      location.href = d.redirect;
    } else {
      alertBox('Unexpected response.');
    }
  });

  // Email OTP submit
  emailOtpForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const code = document.getElementById('emailCode').value.trim();
    if (!/^\d{6}$/.test(code)) {
      return alertBox('Enter the 6-digit code.');
    }

    let r, d;
    try {
      r = await fetch("{% url 'core:verify_email_otp' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrf(),
        },
        body: JSON.stringify({ code }),
      });
      d = await r.json();
    } catch (err) {
      console.error(err);
      return alertBox('Network error. Please try again.');
    }

    if (!r.ok || !d.ok) {
      return alertBox(d.error || 'Invalid code.');
    }

    // For new users, backend should redirect them to /add-card/?next=/profile
    location.href = d.redirect || '/profile';
  });
</script>

</body>
</html>



